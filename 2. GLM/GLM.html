<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Generalized Linear Models</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Generalized Linear Models</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># The easiest way to get recipes is to install all of tidymodels:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># install.packages(&quot;tidymodels&quot;)</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">options</span>(<span class="at">encoding =</span> <span class="st">&#39;UTF-8&#39;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">#Loading all the necessary packages</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;caret&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;caret&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: caret</code></pre>
<pre><code>## Loading required package: ggplot2</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;recipes&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;recipes&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: recipes</code></pre>
<pre><code>## Loading required package: dplyr</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre><code>## 
## Attaching package: &#39;recipes&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     step</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;visreg&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;visreg&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: visreg</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;MASS&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;MASS&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## 
## Attaching package: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;glmnet&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;glmnet&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: glmnet</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loaded glmnet 4.1-8</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;jtools&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;jtools&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: jtools</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;scales&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;scales&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: scales</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;forcats&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;forcats&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: forcats</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;stringr&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;stringr&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: stringr</code></pre>
<pre><code>## 
## Attaching package: &#39;stringr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:recipes&#39;:
## 
##     fixed</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;poissonreg&quot;</span>)) <span class="fu">install.packages</span>(<span class="st">&quot;poissonreg&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: poissonreg</code></pre>
<pre><code>## Loading required package: parsnip</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;caret&quot;</span>)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;recipes&quot;</span>)</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;visreg&quot;</span>)</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;MASS&quot;</span>)</span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;glmnet&quot;</span>)</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;jtools&quot;</span>)</span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;scales&quot;</span>)</span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;forcats&quot;</span>)</span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;stringr&quot;</span>)</span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;arrow&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: arrow</code></pre>
<pre><code>## 
## Attaching package: &#39;arrow&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:utils&#39;:
## 
##     timestamp</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;forcats&quot;</span>)</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;yardstick&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: yardstick</code></pre>
<pre><code>## 
## Attaching package: &#39;yardstick&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:jtools&#39;:
## 
##     get_weights</code></pre>
<pre><code>## The following objects are masked from &#39;package:caret&#39;:
## 
##     precision, recall, sensitivity, specificity</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;parsnip&quot;</span>)</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;workflows&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: workflows</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;poissonreg&quot;</span>)</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;rsample&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: rsample</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;tune&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: tune</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;yardstick&quot;</span>)</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">8</span>, <span class="at">repr.plot.height =</span> <span class="dv">6</span>, <span class="at">repr.plot.res =</span> <span class="dv">150</span>);</span></code></pre></div>
<p>We can also load the data (same as in the previous sessions).</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>dataset <span class="ot">=</span> <span class="fu">read_parquet</span>(<span class="at">file =</span> <span class="st">&quot;../data/dataset.parquet&quot;</span>)</span></code></pre></div>
<div id="data-preparation" class="section level2">
<h2>Data Preparation</h2>
<p>For GLMs, we will need to prepare the data that we feed to the model.
Indeed, we will have to provide the list of variables we wish to use and
also supply the interactions terms. On top of that, we will
<em>probably</em> need to bin some continuous variables into categorical
ones. Let us re-take a look at some of the variables in the dataset.</p>
<p>An important preliminary step is always data preparation. In our
simple dataset, we only have 10 variables. As a reminder, we have the
following variables.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="fu">str</span>(dataset)</span></code></pre></div>
<pre><code>## tibble [410,864 × 10] (S3: tbl_df/tbl/data.frame)
##  $ PolicyID : Factor w/ 413169 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 1 2 3 4 5 6 7 8 9 10 ...
##  $ ClaimNb  : int [1:410864] 0 0 0 0 0 0 0 0 0 0 ...
##  $ Exposure : num [1:410864] 0.09 0.84 0.52 0.45 0.15 0.75 0.81 0.05 0.76 0.34 ...
##  $ Power    : Factor w/ 12 levels &quot;d&quot;,&quot;e&quot;,&quot;f&quot;,&quot;g&quot;,..: 4 4 3 3 4 4 1 1 1 6 ...
##  $ CarAge   : int [1:410864] 0 0 2 2 0 0 1 0 9 0 ...
##  $ DriverAge: int [1:410864] 46 46 38 38 41 41 27 27 23 44 ...
##  $ Brand    : Factor w/ 7 levels &quot;Fiat&quot;,&quot;Japanese (except Nissan) or Korean&quot;,..: 2 2 2 2 2 2 2 2 1 2 ...
##  $ Gas      : Factor w/ 2 levels &quot;Diesel&quot;,&quot;Regular&quot;: 1 1 2 2 1 1 2 2 2 2 ...
##  $ Region   : Factor w/ 10 levels &quot;Aquitaine&quot;,&quot;Basse-Normandie&quot;,..: 1 1 8 8 9 9 1 1 8 6 ...
##  $ Density  : int [1:410864] 76 76 3003 3003 60 60 695 695 7887 27000 ...</code></pre>
<p>As we see, some variables are considered as integers (int) and others
are considered as factors. For factor variable, an important feature is
the <strong>reference level</strong>. R automatically assigns the
<strong>first category/value</strong> encountered as reference level.
This can often be suboptimal, and it is preferable to have as reference
level the category with the most observation (or largest exposure).</p>
<div id="brand" class="section level3">
<h3>Brand</h3>
<p>We can see the different levels of a factor variable with the levels
function. The first level is the <strong>reference level</strong>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="fu">levels</span>(dataset<span class="sc">$</span>Brand)</span></code></pre></div>
<pre><code>## [1] &quot;Fiat&quot;                               &quot;Japanese (except Nissan) or Korean&quot;
## [3] &quot;Mercedes, Chrysler or BMW&quot;          &quot;Opel, General Motors or Ford&quot;      
## [5] &quot;other&quot;                              &quot;Renault, Nissan or Citroen&quot;        
## [7] &quot;Volkswagen, Audi, Skoda or Seat&quot;</code></pre>
<p>Using the function <em>fct_count</em> from package <em>forcats</em>
we can easily compute the number of rows for each level of the factor
variable.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>dataset<span class="sc">$</span>Brand <span class="sc">%&gt;%</span> <span class="fu">fct_count</span>(<span class="at">sort=</span><span class="cn">TRUE</span>, <span class="at">prop=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 7 × 3
##   f                                       n      p
##   &lt;fct&gt;                               &lt;int&gt;  &lt;dbl&gt;
## 1 Renault, Nissan or Citroen         216684 0.527 
## 2 Japanese (except Nissan) or Korean  79031 0.192 
## 3 Opel, General Motors or Ford        37287 0.0908
## 4 Volkswagen, Audi, Skoda or Seat     32384 0.0788
## 5 Mercedes, Chrysler or BMW           19087 0.0465
## 6 Fiat                                16653 0.0405
## 7 other                                9738 0.0237</code></pre>
<p><em>Renault, Nissan or Citroen</em> appears to be the most populated
level of variable ‘Brand’. This is why we will set this level as
reference level, using the function <strong>relevel</strong>, or we can
directly use the relevant function from the forcats package that will
determine the most populated level and set that level as the reference
level.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="co"># dataset$Brand = relevel(x = dataset$Brand, ref= &quot;Renault, Nissan or Citroen&quot;)</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="co"># Easier with forcats</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>dataset<span class="sc">$</span>Brand <span class="ot">=</span> dataset<span class="sc">$</span>Brand <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>()</span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a><span class="fu">levels</span>(dataset<span class="sc">$</span>Brand)</span></code></pre></div>
<pre><code>## [1] &quot;Renault, Nissan or Citroen&quot;         &quot;Japanese (except Nissan) or Korean&quot;
## [3] &quot;Opel, General Motors or Ford&quot;       &quot;Volkswagen, Audi, Skoda or Seat&quot;   
## [5] &quot;Mercedes, Chrysler or BMW&quot;          &quot;Fiat&quot;                              
## [7] &quot;other&quot;</code></pre>
</div>
<div id="gas" class="section level3">
<h3>Gas</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>dataset<span class="sc">$</span>Gas <span class="sc">%&gt;%</span> <span class="fu">fct_count</span>(<span class="at">sort=</span><span class="cn">TRUE</span>, <span class="at">prop=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   f            n     p
##   &lt;fct&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 Regular 205565 0.500
## 2 Diesel  205299 0.500</code></pre>
<p>We will set Regular as reference level.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>dataset<span class="sc">$</span>Gas <span class="ot">=</span> dataset<span class="sc">$</span>Gas <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>()</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a><span class="fu">levels</span>(dataset<span class="sc">$</span>Gas)</span></code></pre></div>
<pre><code>## [1] &quot;Regular&quot; &quot;Diesel&quot;</code></pre>
</div>
<div id="region" class="section level3">
<h3>Region</h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>dataset<span class="sc">$</span>Region <span class="sc">%&gt;%</span> <span class="fu">fct_count</span>(<span class="at">sort=</span><span class="cn">TRUE</span>, <span class="at">prop=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 3
##    f                       n      p
##    &lt;fct&gt;               &lt;int&gt;  &lt;dbl&gt;
##  1 Centre             159426 0.388 
##  2 Ile-de-France       69576 0.169 
##  3 Bretagne            41986 0.102 
##  4 Pays-de-la-Loire    38541 0.0938
##  5 Aquitaine           31211 0.0760
##  6 Nord-Pas-de-Calais  27111 0.0660
##  7 Poitou-Charentes    18900 0.0460
##  8 Basse-Normandie     10848 0.0264
##  9 Haute-Normandie      8726 0.0212
## 10 Limousin             4539 0.0110</code></pre>
<p>We will set Center as reference level.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>dataset<span class="sc">$</span>Region <span class="ot">=</span> dataset<span class="sc">$</span>Region <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>()</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a><span class="fu">levels</span>(dataset<span class="sc">$</span>Region)</span></code></pre></div>
<pre><code>##  [1] &quot;Centre&quot;             &quot;Ile-de-France&quot;      &quot;Bretagne&quot;          
##  [4] &quot;Pays-de-la-Loire&quot;   &quot;Aquitaine&quot;          &quot;Nord-Pas-de-Calais&quot;
##  [7] &quot;Poitou-Charentes&quot;   &quot;Basse-Normandie&quot;    &quot;Haute-Normandie&quot;   
## [10] &quot;Limousin&quot;</code></pre>
</div>
<div id="power" class="section level3">
<h3>Power</h3>
<p>Power is bit of a different factor variable. Indeed, there is some
order between the levels (from lower power to higher power).</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>dataset<span class="sc">$</span>Power <span class="sc">%&gt;%</span> <span class="fu">fct_count</span>(<span class="at">sort=</span><span class="cn">TRUE</span>, <span class="at">prop=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 12 × 3
##    f         n       p
##    &lt;fct&gt; &lt;int&gt;   &lt;dbl&gt;
##  1 f     95432 0.232  
##  2 g     90663 0.221  
##  3 e     76784 0.187  
##  4 d     67660 0.165  
##  5 h     26558 0.0646 
##  6 j     17978 0.0438 
##  7 i     17398 0.0423 
##  8 k      9270 0.0226 
##  9 l      4593 0.0112 
## 10 m      1758 0.00428
## 11 o      1494 0.00364
## 12 n      1276 0.00311</code></pre>
<p>We will leave <em>d</em> as reference level, as it is highly
populated and will allow us to keep it simple to interpret the
regression coefficients (levels are ordered).</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>dataset<span class="sc">$</span>Power <span class="ot">=</span> dataset<span class="sc">$</span>Power <span class="sc">%&gt;%</span> <span class="fu">fct_relevel</span>(sort)</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a><span class="fu">levels</span>(dataset<span class="sc">$</span>Power)</span></code></pre></div>
<pre><code>##  [1] &quot;d&quot; &quot;e&quot; &quot;f&quot; &quot;g&quot; &quot;h&quot; &quot;i&quot; &quot;j&quot; &quot;k&quot; &quot;l&quot; &quot;m&quot; &quot;n&quot; &quot;o&quot;</code></pre>
</div>
</div>
<div id="model" class="section level2">
<h2>Model</h2>
<p>We are going to model the claim frequencies using a GLM. We will only
consider the categorical variables in this part, as we will see later
that other tools are available to treat the continuous variables without
having to discretize them.</p>
<p>Let us first split our dataset in two parts: a training set and a
testing set (this step requires the caret package).</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">21</span>)  <span class="co"># For reproducibility</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>in_training <span class="ot">=</span> <span class="fu">createDataPartition</span>(dataset<span class="sc">$</span>ClaimNb, <span class="at">times =</span> <span class="dv">1</span>, <span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a>training_set <span class="ot">=</span> dataset[in_training, ]</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a>testing_set <span class="ot">=</span> dataset[<span class="sc">-</span>in_training, ]</span></code></pre></div>
<div id="intercept" class="section level3">
<h3>Intercept</h3>
<p>The main function is called <em>glm</em>. Let us run the function on
our training set. We will need to provide the offset to account for the
different Exposures.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a>m0 <span class="ot">=</span> <span class="fu">glm</span>(ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)), </span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>         <span class="at">data =</span> training_set, </span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a>         <span class="at">family =</span> <span class="fu">poisson</span>())</span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a><span class="fu">summary</span>(m0)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = ClaimNb ~ offset(log(Exposure)), family = poisson(), 
##     data = training_set)
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -2.655615   0.008789  -302.1   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 84299  on 328691  degrees of freedom
## AIC: 109308
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>By default, the link function is the log (see help file
?poisson).</p>
<p>In a GLM without any variables, the exponential of the intercept
<span class="math inline">\(\exp\beta_0\)</span> corresponds to the
average claim frequency.</p>
<p>Indeed, if we compare <span class="math inline">\(\exp\beta_0\)</span> with <span class="math inline">\(\displaystyle\frac{\sum_i ClaimNB_i}{\sum_i
Exposure_i}\)</span>, we obtain</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="fu">list</span>(<span class="fu">exp</span>(m0<span class="sc">$</span>coef[<span class="dv">1</span>]), <span class="co"># m0$coef[1] is the Intercept</span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>     <span class="fu">with</span>(training_set, <span class="fu">sum</span>(ClaimNb) <span class="sc">/</span> <span class="fu">sum</span>(Exposure)))</span></code></pre></div>
<pre><code>## [[1]]
## (Intercept) 
##  0.07025564 
## 
## [[2]]
## [1] 0.07025564</code></pre>
</div>
<div id="include-variables" class="section level3">
<h3>Include Variables</h3>
<p>First, we will only consider the discrete variables, namely Power,
Brand, Gas and Region.</p>
<p>Let us include all these variables (without interactions) in the
model.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>m1 <span class="ot">=</span> <span class="fu">glm</span>(ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Brand <span class="sc">+</span> Region, </span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>         <span class="at">data =</span> training_set,</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>         <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> log))</span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a><span class="fu">summary</span>(m1)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = ClaimNb ~ offset(log(Exposure)) + Power + Gas + 
##     Brand + Region, family = poisson(link = log), data = training_set)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92738    0.02686 -108.980  &lt; 2e-16
## Powere                                   0.08199    0.03121    2.627 0.008622
## Powerf                                   0.08333    0.03058    2.725 0.006430
## Powerg                                   0.04901    0.03044    1.610 0.107353
## Powerh                                   0.08583    0.04350    1.973 0.048475
## Poweri                                   0.18977    0.04841    3.920 8.87e-05
## Powerj                                   0.18583    0.04873    3.814 0.000137
## Powerk                                   0.20036    0.06432    3.115 0.001839
## Powerl                                   0.10847    0.09418    1.152 0.249470
## Powerm                                   0.24356    0.13330    1.827 0.067683
## Powern                                   0.20713    0.15903    1.302 0.192752
## Powero                                   0.26127    0.15324    1.705 0.088208
## GasDiesel                                0.12636    0.01886    6.700 2.09e-11
## BrandJapanese (except Nissan) or Korean -0.19473    0.03059   -6.365 1.95e-10
## BrandOpel, General Motors or Ford        0.14284    0.02983    4.788 1.68e-06
## BrandVolkswagen, Audi, Skoda or Seat     0.14182    0.03169    4.476 7.62e-06
## BrandMercedes, Chrysler or BMW           0.07159    0.04424    1.618 0.105662
## BrandFiat                                0.09812    0.04380    2.240 0.025061
## Brandother                               0.03085    0.05674    0.544 0.586670
## RegionIle-de-France                      0.38849    0.02835   13.702  &lt; 2e-16
## RegionBretagne                           0.04931    0.02954    1.670 0.095010
## RegionPays-de-la-Loire                   0.15946    0.03129    5.096 3.46e-07
## RegionAquitaine                          0.17098    0.03795    4.506 6.62e-06
## RegionNord-Pas-de-Calais                 0.31214    0.03946    7.910 2.58e-15
## RegionPoitou-Charentes                   0.16466    0.04142    3.975 7.03e-05
## RegionBasse-Normandie                    0.11350    0.05389    2.106 0.035185
## RegionHaute-Normandie                    0.13236    0.07685    1.722 0.085024
## RegionLimousin                           0.41227    0.07692    5.360 8.34e-08
##                                            
## (Intercept)                             ***
## Powere                                  ** 
## Powerf                                  ** 
## Powerg                                     
## Powerh                                  *  
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                  .  
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## BrandJapanese (except Nissan) or Korean ***
## BrandOpel, General Motors or Ford       ***
## BrandVolkswagen, Audi, Skoda or Seat    ***
## BrandMercedes, Chrysler or BMW             
## BrandFiat                               *  
## Brandother                                 
## RegionIle-de-France                     ***
## RegionBretagne                          .  
## RegionPays-de-la-Loire                  ***
## RegionAquitaine                         ***
## RegionNord-Pas-de-Calais                ***
## RegionPoitou-Charentes                  ***
## RegionBasse-Normandie                   *  
## RegionHaute-Normandie                   .  
## RegionLimousin                          ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83916  on 328664  degrees of freedom
## AIC: 108979
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<div id="visualize-the-model" class="section level4">
<h4>Visualize the model</h4>
<p>For GLMs we don’t need partial dependence plots, as we have a clear
formula explaining the relationship between the features and the
response variable.</p>
<p>We will use the function visreg from package <strong>visreg</strong>
to plot the coefficients, along with their confidence interval. We can
specify the <strong>type</strong> of plot we want:</p>
<p>From the documentation of <em>visreg</em>, we can read the
following</p>
<p>The type of plot to be produced. The following options are
supported:</p>
<ul>
<li>If <strong>conditional</strong> is selected, the plot returned shows
the value of the variable on the x-axis and the change in response on
the y-axis, holding all other variables constant (by default, median for
numeric variables and most common category for factors).</li>
<li>If <strong>contrast</strong> is selected, the plot returned shows
the effect on the expected value of the response by moving the x
variable away from a reference point on the x-axis (for numeric
variables, this is taken to be the mean).</li>
</ul>
<p>If we want to have the coefficients on the claim frequency scale, we
can specify <em>scale = “response”</em>. Otherwise we can specify
<em>scale = “linear”</em> to see the <span class="math inline">\(\displaystyle\beta\)</span>s</p>
<div id="power-1" class="section level5">
<h5>Power</h5>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="fu">visreg</span>(m1, <span class="st">&quot;Power&quot;</span>, <span class="at">type=</span><span class="st">&quot;conditional&quot;</span>, <span class="at">scale=</span><span class="st">&quot;response&quot;</span>, <span class="at">gg=</span><span class="cn">TRUE</span>, <span class="at">rug=</span><span class="cn">FALSE</span>, <span class="at">partial=</span><span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="fu">visreg</span>(m1, <span class="st">&quot;Power&quot;</span>, <span class="at">type=</span><span class="st">&quot;contrast&quot;</span>, <span class="at">scale=</span><span class="st">&quot;response&quot;</span>, <span class="at">gg=</span><span class="cn">TRUE</span>, <span class="at">rug=</span><span class="cn">FALSE</span>, <span class="at">partial=</span><span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<pre><code>## Warning: You are attempting to transform a contrast.  The resulting plot is not
## guaranteed to be meaningful.</code></pre>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="gas-1" class="section level5">
<h5>Gas</h5>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="fu">visreg</span>(m1, <span class="st">&quot;Gas&quot;</span>, <span class="at">type=</span><span class="st">&quot;contrast&quot;</span>, <span class="at">scale=</span><span class="st">&quot;response&quot;</span>, <span class="at">gg=</span><span class="cn">TRUE</span>, <span class="at">rug=</span><span class="cn">FALSE</span>, <span class="at">partial=</span><span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<pre><code>## Warning: You are attempting to transform a contrast.  The resulting plot is not
## guaranteed to be meaningful.</code></pre>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="region-1" class="section level5">
<h5>Region</h5>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="fu">visreg</span>(m1, <span class="st">&quot;Region&quot;</span>, <span class="at">type=</span><span class="st">&quot;contrast&quot;</span>, <span class="at">scale=</span><span class="st">&quot;response&quot;</span>, <span class="at">gg=</span><span class="cn">TRUE</span>, <span class="at">rug=</span><span class="cn">FALSE</span>, <span class="at">partial=</span><span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## Warning: You are attempting to transform a contrast.  The resulting plot is not
## guaranteed to be meaningful.</code></pre>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="brand-1" class="section level5">
<h5>Brand</h5>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="fu">visreg</span>(m1, <span class="st">&quot;Brand&quot;</span>, <span class="at">type=</span><span class="st">&quot;contrast&quot;</span>, <span class="at">scale=</span><span class="st">&quot;response&quot;</span>, <span class="at">gg=</span><span class="cn">TRUE</span>, <span class="at">rug=</span><span class="cn">FALSE</span>, <span class="at">partial=</span><span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## Warning: You are attempting to transform a contrast.  The resulting plot is not
## guaranteed to be meaningful.</code></pre>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
</div>
<div id="comparing-two-models" class="section level4">
<h4>Comparing two models</h4>
<p>We see some levels of some variables appear to be not significantly
different from 0 (or 1 on the response scale). Moreover, it could be
that some levels appear to be significantly different from 0, but are
not significantly different from each other and could be merged.</p>
<p>If we wish to perform a likelihood ratio test between the full model
<span class="math inline">\(m_1\)</span> and the model without any
explanatory variables <span class="math inline">\(m_0\)</span> :</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="fu">anova</span>(m0, m1, <span class="at">test =</span> <span class="st">&quot;Chisq&quot;</span>)</span></code></pre></div>
<pre><code>## Analysis of Deviance Table
## 
## Model 1: ClaimNb ~ offset(log(Exposure))
## Model 2: ClaimNb ~ offset(log(Exposure)) + Power + Gas + Brand + Region
##   Resid. Df Resid. Dev Df Deviance  Pr(&gt;Chi)    
## 1    328691      84299                          
## 2    328664      83916 27   382.74 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Note:</p>
<p>Null Deviance = 2(LL(Saturated Model) - LL(Null Model)) with df =
df_Sat - df_Null</p>
<p>Residual Deviance = 2(LL(Saturated Model) - LL(Proposed Model)) with
df = df_Sat - df_Proposed</p>
<div id="predict-claim-frequencies" class="section level5">
<h5>Predict claim frequencies</h5>
<p>If we want to predict claim frequencies, we can directly use the
predict function. We need to specify that the output needs to be of
<em>type = “response”</em>, so that we obtain claim frequencies, rather
than the linear predictor (on the “score” scale). For example, for the
first four lines of the testing_set, we get:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a><span class="fu">predict</span>(m1, <span class="fu">head</span>(testing_set, <span class="dv">4</span>), <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span></code></pre></div>
<pre><code>##           1           2           3           4 
## 0.005607189 0.002614029 0.061326100 0.013401838</code></pre>
</div>
</div>
</div>
<div id="offset-or-weights" class="section level3">
<h3>Offset or weights ?</h3>
<p>Let us compare the previous model with the following model, which,
some call a “Poisson rate model”)</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a>m2 <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">glm</span>(ClaimNb<span class="sc">/</span>Exposure <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Brand <span class="sc">+</span> Region, </span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>         <span class="at">data =</span> training_set,</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a>         <span class="at">weight =</span> training_set<span class="sc">$</span>Exposure,</span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a>         <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> log)))</span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = ClaimNb/Exposure ~ Power + Gas + Brand + Region, 
##     family = poisson(link = log), data = training_set, weights = training_set$Exposure)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92738    0.02686 -108.978  &lt; 2e-16
## Powere                                   0.08199    0.03121    2.627 0.008623
## Powerf                                   0.08333    0.03058    2.725 0.006431
## Powerg                                   0.04901    0.03044    1.610 0.107361
## Powerh                                   0.08583    0.04350    1.973 0.048480
## Poweri                                   0.18977    0.04842    3.920 8.87e-05
## Powerj                                   0.18583    0.04873    3.814 0.000137
## Powerk                                   0.20036    0.06432    3.115 0.001839
## Powerl                                   0.10847    0.09419    1.152 0.249486
## Powerm                                   0.24356    0.13331    1.827 0.067686
## Powern                                   0.20713    0.15903    1.302 0.192759
## Powero                                   0.26127    0.15325    1.705 0.088217
## GasDiesel                                0.12636    0.01886    6.700 2.09e-11
## BrandJapanese (except Nissan) or Korean -0.19473    0.03059   -6.365 1.95e-10
## BrandOpel, General Motors or Ford        0.14284    0.02983    4.788 1.68e-06
## BrandVolkswagen, Audi, Skoda or Seat     0.14182    0.03169    4.475 7.62e-06
## BrandMercedes, Chrysler or BMW           0.07159    0.04424    1.618 0.105666
## BrandFiat                                0.09812    0.04380    2.240 0.025063
## Brandother                               0.03085    0.05674    0.544 0.586673
## RegionIle-de-France                      0.38849    0.02835   13.701  &lt; 2e-16
## RegionBretagne                           0.04931    0.02954    1.670 0.095012
## RegionPays-de-la-Loire                   0.15946    0.03129    5.096 3.46e-07
## RegionAquitaine                          0.17098    0.03795    4.505 6.62e-06
## RegionNord-Pas-de-Calais                 0.31214    0.03946    7.910 2.58e-15
## RegionPoitou-Charentes                   0.16466    0.04142    3.975 7.03e-05
## RegionBasse-Normandie                    0.11350    0.05389    2.106 0.035186
## RegionHaute-Normandie                    0.13236    0.07686    1.722 0.085060
## RegionLimousin                           0.41227    0.07692    5.360 8.34e-08
##                                            
## (Intercept)                             ***
## Powere                                  ** 
## Powerf                                  ** 
## Powerg                                     
## Powerh                                  *  
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                  .  
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## BrandJapanese (except Nissan) or Korean ***
## BrandOpel, General Motors or Ford       ***
## BrandVolkswagen, Audi, Skoda or Seat    ***
## BrandMercedes, Chrysler or BMW             
## BrandFiat                               *  
## Brandother                                 
## RegionIle-de-France                     ***
## RegionBretagne                          .  
## RegionPays-de-la-Loire                  ***
## RegionAquitaine                         ***
## RegionNord-Pas-de-Calais                ***
## RegionPoitou-Charentes                  ***
## RegionBasse-Normandie                   *  
## RegionHaute-Normandie                   .  
## RegionLimousin                          ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83916  on 328664  degrees of freedom
## AIC: Inf
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>Let us compare the coefficients</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="fu">cbind</span>(m1<span class="sc">$</span>coef, m2<span class="sc">$</span>coef)</span></code></pre></div>
<pre><code>##                                                [,1]        [,2]
## (Intercept)                             -2.92738024 -2.92738024
## Powere                                   0.08198571  0.08198571
## Powerf                                   0.08333279  0.08333279
## Powerg                                   0.04900718  0.04900718
## Powerh                                   0.08583395  0.08583395
## Poweri                                   0.18976716  0.18976716
## Powerj                                   0.18583253  0.18583253
## Powerk                                   0.20036184  0.20036184
## Powerl                                   0.10846684  0.10846685
## Powerm                                   0.24356215  0.24356215
## Powern                                   0.20713451  0.20713452
## Powero                                   0.26126817  0.26126817
## GasDiesel                                0.12636323  0.12636323
## BrandJapanese (except Nissan) or Korean -0.19472915 -0.19472916
## BrandOpel, General Motors or Ford        0.14283577  0.14283577
## BrandVolkswagen, Audi, Skoda or Seat     0.14181615  0.14181615
## BrandMercedes, Chrysler or BMW           0.07158682  0.07158682
## BrandFiat                                0.09812290  0.09812290
## Brandother                               0.03084709  0.03084709
## RegionIle-de-France                      0.38849148  0.38849148
## RegionBretagne                           0.04931014  0.04931014
## RegionPays-de-la-Loire                   0.15945625  0.15945625
## RegionAquitaine                          0.17097891  0.17097891
## RegionNord-Pas-de-Calais                 0.31214444  0.31214443
## RegionPoitou-Charentes                   0.16466143  0.16466143
## RegionBasse-Normandie                    0.11349562  0.11349562
## RegionHaute-Normandie                    0.13235510  0.13235507
## RegionLimousin                           0.41227457  0.41227457</code></pre>
<p>Why does that work ? See course notes or : <a href="https://stats.stackexchange.com/a/270151" class="uri">https://stats.stackexchange.com/a/270151</a></p>
</div>
<div id="remarks" class="section level3">
<h3>Remarks</h3>
<p>Up to now, we have</p>
<ol style="list-style-type: decimal">
<li>Load the original dataset.</li>
<li>We have prepared the data in some way (relevel the factors we
instance). We could have binned the continuous variables.</li>
<li>Run a model on these variables.</li>
<li>Predict for some new observations (-&gt; testing set ?).</li>
</ol>
<p>There are some flaws in the way of working.</p>
<ul>
<li><p>We should not prepare the data <em>before</em> splitting into
training and testing set. Although, we did not include information from
the testing set into the training set here, we could have done so, if,
for example, we were to standardize some variables. Indeed, if we
standardize a continuous variable by substracting the mean and dividing
by the standard deviation, since we have computed the mean and the
standard deviation on the whole dataset (rather than only on the
training set), we include information about the testing_set into the
training_set and the otherway around as well.</p></li>
<li><p>What if new data comes ? How will we handle this ? Do we need to
reprocess the data preparation again ? How do we keep track of all the
preprocessing that we have done ?</p></li>
</ul>
<p>One way to handle this issue correctly is working with
<strong>recipes</strong> (<a href="https://recipes.tidymodels.org/index.html" class="uri">https://recipes.tidymodels.org/index.html</a>). So, let’s
restart this session and use <strong>recipes</strong>.</p>
<p>We will reload the data from the parquet files and directly split the
data into a training and a testing set.</p>
</div>
</div>
<div id="restart-with-recipes" class="section level2">
<h2>Restart with recipes</h2>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a>dataset <span class="ot">=</span> <span class="fu">read_parquet</span>(<span class="at">file =</span> <span class="st">&quot;../data/dataset.parquet&quot;</span>)</span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">21</span>)</span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a>in_training <span class="ot">=</span> <span class="fu">createDataPartition</span>(dataset<span class="sc">$</span>ClaimNb, <span class="at">times =</span> <span class="dv">1</span>, <span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb97-5"><a href="#cb97-5" tabindex="-1"></a>training_set <span class="ot">=</span> dataset[in_training, ]</span>
<span id="cb97-6"><a href="#cb97-6" tabindex="-1"></a>testing_set <span class="ot">=</span> dataset[<span class="sc">-</span>in_training, ]</span></code></pre></div>
<p>We can specify a <em>recipe</em> to prepare the data correctly. The
idea is to define this once, and apply it on different datasets, so we
don’t need to preprocess the data manually.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a>rec_0 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Exposure <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Brand <span class="sc">+</span> Region, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="#cb98-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="#cb98-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="#cb98-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-6"><a href="#cb98-6" tabindex="-1"></a>    <span class="fu">prep</span>()</span>
<span id="cb98-7"><a href="#cb98-7" tabindex="-1"></a>rec_0</span></code></pre></div>
<pre><code>## </code></pre>
<pre><code>## ── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
<pre><code>## </code></pre>
<pre><code>## ── Inputs</code></pre>
<pre><code>## Number of variables by role</code></pre>
<pre><code>## outcome:   1
## predictor: 5</code></pre>
<pre><code>## </code></pre>
<pre><code>## ── Training information</code></pre>
<pre><code>## Training data contained 328692 data points and no incomplete rows.</code></pre>
<pre><code>## </code></pre>
<pre><code>## ── Operations</code></pre>
<pre><code>## • Re-order factor level to ref_level for: Power | Trained</code></pre>
<pre><code>## • Re-order factor level to ref_level for: Gas | Trained</code></pre>
<pre><code>## • Re-order factor level to ref_level for: Region | Trained</code></pre>
<pre><code>## • Re-order factor level to ref_level for: Brand | Trained</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" tabindex="-1"></a>output <span class="ot">=</span> <span class="fu">bake</span>(rec_0, <span class="at">new_data =</span> <span class="fu">head</span>(training_set, <span class="dv">4</span>))</span>
<span id="cb114-2"><a href="#cb114-2" tabindex="-1"></a>output</span></code></pre></div>
<pre><code>## # A tibble: 4 × 6
##   Exposure Power Gas     Brand                              Region       ClaimNb
##      &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;   &lt;fct&gt;                              &lt;fct&gt;          &lt;int&gt;
## 1     0.84 g     Diesel  Japanese (except Nissan) or Korean Aquitaine          0
## 2     0.52 f     Regular Japanese (except Nissan) or Korean Nord-Pas-de…       0
## 3     0.45 f     Regular Japanese (except Nissan) or Korean Nord-Pas-de…       0
## 4     0.15 g     Diesel  Japanese (except Nissan) or Korean Pays-de-la-…       0</code></pre>
<p>Let us check the reference levels of the output</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" tabindex="-1"></a><span class="fu">str</span>(output)</span></code></pre></div>
<pre><code>## tibble [4 × 6] (S3: tbl_df/tbl/data.frame)
##  $ Exposure: num [1:4] 0.84 0.52 0.45 0.15
##  $ Power   : Factor w/ 12 levels &quot;d&quot;,&quot;e&quot;,&quot;f&quot;,&quot;g&quot;,..: 4 3 3 4
##  $ Gas     : Factor w/ 2 levels &quot;Regular&quot;,&quot;Diesel&quot;: 2 1 1 2
##  $ Brand   : Factor w/ 7 levels &quot;Renault, Nissan or Citroen&quot;,..: 3 3 3 3
##  $ Region  : Factor w/ 10 levels &quot;Centre&quot;,&quot;Aquitaine&quot;,..: 2 8 8 9
##  $ ClaimNb : int [1:4] 0 0 0 0</code></pre>
<p>to be compared with</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" tabindex="-1"></a><span class="fu">str</span>(training_set)</span></code></pre></div>
<pre><code>## tibble [328,692 × 10] (S3: tbl_df/tbl/data.frame)
##  $ PolicyID : Factor w/ 413169 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 2 3 4 5 6 7 10 11 12 13 ...
##  $ ClaimNb  : int [1:328692] 0 0 0 0 0 0 0 0 0 0 ...
##  $ Exposure : num [1:328692] 0.84 0.52 0.45 0.15 0.75 0.81 0.34 0.1 0.77 0.55 ...
##  $ Power    : Factor w/ 12 levels &quot;d&quot;,&quot;e&quot;,&quot;f&quot;,&quot;g&quot;,..: 4 3 3 4 4 1 6 3 3 2 ...
##  $ CarAge   : int [1:328692] 0 2 2 0 0 1 0 2 2 0 ...
##  $ DriverAge: int [1:328692] 46 38 38 41 41 27 44 32 32 33 ...
##  $ Brand    : Factor w/ 7 levels &quot;Fiat&quot;,&quot;Japanese (except Nissan) or Korean&quot;,..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Gas      : Factor w/ 2 levels &quot;Diesel&quot;,&quot;Regular&quot;: 1 2 2 1 1 2 2 1 1 2 ...
##  $ Region   : Factor w/ 10 levels &quot;Aquitaine&quot;,&quot;Basse-Normandie&quot;,..: 1 8 8 9 9 1 6 4 4 6 ...
##  $ Density  : int [1:328692] 76 3003 3003 60 60 695 27000 23 23 1746 ...</code></pre>
<p>We can use the recipe on the training and the testing set, and
construct the same GLM as above. We can check that the results are the
same and that we can predict on the testing set</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" tabindex="-1"></a>train_baked <span class="ot">=</span> <span class="fu">bake</span>(rec_0, <span class="at">new_data =</span> training_set)</span>
<span id="cb120-2"><a href="#cb120-2" tabindex="-1"></a>test_baked <span class="ot">=</span> <span class="fu">bake</span>(rec_0, <span class="at">new_data =</span> testing_set) </span>
<span id="cb120-3"><a href="#cb120-3" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" tabindex="-1"></a>m3 <span class="ot">=</span> <span class="fu">glm</span>(ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Brand <span class="sc">+</span> Region, <span class="at">data =</span> train_baked, <span class="at">family =</span> <span class="fu">poisson</span>())</span>
<span id="cb120-5"><a href="#cb120-5" tabindex="-1"></a><span class="fu">summary</span>(m3)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = ClaimNb ~ offset(log(Exposure)) + Power + Gas + 
##     Brand + Region, family = poisson(), data = train_baked)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92738    0.02686 -108.980  &lt; 2e-16
## Powere                                   0.08199    0.03121    2.627 0.008622
## Powerf                                   0.08333    0.03058    2.725 0.006430
## Powerg                                   0.04901    0.03044    1.610 0.107353
## Powerh                                   0.08583    0.04350    1.973 0.048475
## Poweri                                   0.18977    0.04841    3.920 8.87e-05
## Powerj                                   0.18583    0.04873    3.814 0.000137
## Powerk                                   0.20036    0.06432    3.115 0.001839
## Powerl                                   0.10847    0.09418    1.152 0.249470
## Powerm                                   0.24356    0.13330    1.827 0.067683
## Powern                                   0.20713    0.15903    1.302 0.192752
## Powero                                   0.26127    0.15324    1.705 0.088208
## GasDiesel                                0.12636    0.01886    6.700 2.09e-11
## BrandFiat                                0.09812    0.04380    2.240 0.025061
## BrandJapanese (except Nissan) or Korean -0.19473    0.03059   -6.365 1.95e-10
## BrandMercedes, Chrysler or BMW           0.07159    0.04424    1.618 0.105662
## BrandOpel, General Motors or Ford        0.14284    0.02983    4.788 1.68e-06
## Brandother                               0.03085    0.05674    0.544 0.586670
## BrandVolkswagen, Audi, Skoda or Seat     0.14182    0.03169    4.476 7.62e-06
## RegionAquitaine                          0.17098    0.03795    4.506 6.62e-06
## RegionBasse-Normandie                    0.11350    0.05389    2.106 0.035185
## RegionBretagne                           0.04931    0.02954    1.670 0.095010
## RegionHaute-Normandie                    0.13236    0.07685    1.722 0.085024
## RegionIle-de-France                      0.38849    0.02835   13.702  &lt; 2e-16
## RegionLimousin                           0.41227    0.07692    5.360 8.34e-08
## RegionNord-Pas-de-Calais                 0.31214    0.03946    7.910 2.58e-15
## RegionPays-de-la-Loire                   0.15946    0.03129    5.096 3.46e-07
## RegionPoitou-Charentes                   0.16466    0.04142    3.975 7.03e-05
##                                            
## (Intercept)                             ***
## Powere                                  ** 
## Powerf                                  ** 
## Powerg                                     
## Powerh                                  *  
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                  .  
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## BrandFiat                               *  
## BrandJapanese (except Nissan) or Korean ***
## BrandMercedes, Chrysler or BMW             
## BrandOpel, General Motors or Ford       ***
## Brandother                                 
## BrandVolkswagen, Audi, Skoda or Seat    ***
## RegionAquitaine                         ***
## RegionBasse-Normandie                   *  
## RegionBretagne                          .  
## RegionHaute-Normandie                   .  
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  ***
## RegionPoitou-Charentes                  ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83916  on 328664  degrees of freedom
## AIC: 108979
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" tabindex="-1"></a>coefs_m1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(m1<span class="sc">$</span>coef) <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>()</span>
<span id="cb122-2"><a href="#cb122-2" tabindex="-1"></a>coefs_m3 <span class="ot">=</span> <span class="fu">as.data.frame</span>(m3<span class="sc">$</span>coef) <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>()</span>
<span id="cb122-3"><a href="#cb122-3" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" tabindex="-1"></a>coefs_m1 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(coefs_m3)</span></code></pre></div>
<pre><code>## Joining with `by = join_by(rowname)`</code></pre>
<pre><code>##                                    rowname     m1$coef     m3$coef
## 1                              (Intercept) -2.92738024 -2.92738024
## 2                                   Powere  0.08198571  0.08198571
## 3                                   Powerf  0.08333279  0.08333279
## 4                                   Powerg  0.04900718  0.04900718
## 5                                   Powerh  0.08583395  0.08583395
## 6                                   Poweri  0.18976716  0.18976716
## 7                                   Powerj  0.18583253  0.18583253
## 8                                   Powerk  0.20036184  0.20036184
## 9                                   Powerl  0.10846684  0.10846684
## 10                                  Powerm  0.24356215  0.24356215
## 11                                  Powern  0.20713451  0.20713451
## 12                                  Powero  0.26126817  0.26126817
## 13                               GasDiesel  0.12636323  0.12636323
## 14 BrandJapanese (except Nissan) or Korean -0.19472915 -0.19472915
## 15       BrandOpel, General Motors or Ford  0.14283577  0.14283577
## 16    BrandVolkswagen, Audi, Skoda or Seat  0.14181615  0.14181615
## 17          BrandMercedes, Chrysler or BMW  0.07158682  0.07158682
## 18                               BrandFiat  0.09812290  0.09812290
## 19                              Brandother  0.03084709  0.03084709
## 20                     RegionIle-de-France  0.38849148  0.38849148
## 21                          RegionBretagne  0.04931014  0.04931014
## 22                  RegionPays-de-la-Loire  0.15945625  0.15945625
## 23                         RegionAquitaine  0.17097891  0.17097891
## 24                RegionNord-Pas-de-Calais  0.31214444  0.31214444
## 25                  RegionPoitou-Charentes  0.16466143  0.16466143
## 26                   RegionBasse-Normandie  0.11349562  0.11349562
## 27                   RegionHaute-Normandie  0.13235510  0.13235510
## 28                          RegionLimousin  0.41227457  0.41227457</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" tabindex="-1"></a><span class="fu">predict</span>(m3, <span class="fu">head</span>(test_baked), <span class="at">type=</span><span class="st">&quot;response&quot;</span>)</span></code></pre></div>
<pre><code>##           1           2           3           4           5           6 
## 0.005607189 0.002614029 0.061326100 0.013401838 0.009427595 0.055560893</code></pre>
<p><strong>But,</strong> we still need to bake the testing set before
calling the predict function. <strong>What if we don’t want to call this
bake function anymore ?</strong></p>
</div>
<div id="use-workflows-and-parsnip-to-specify-model" class="section level2">
<h2>Use Workflows and parsnip to specify model</h2>
<p>We can define a workflow that first prepares the data and then goes
into the model to either fit or predict.</p>
<p>A list of models that work with parsnip is provided here: <a href="https://www.tidymodels.org/find/parsnip/" class="uri">https://www.tidymodels.org/find/parsnip/</a></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" tabindex="-1"></a><span class="co"># Copy paste from above:</span></span>
<span id="cb127-2"><a href="#cb127-2" tabindex="-1"></a>rec_4 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb127-3"><a href="#cb127-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-4"><a href="#cb127-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-5"><a href="#cb127-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-6"><a href="#cb127-6" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-7"><a href="#cb127-7" tabindex="-1"></a>    <span class="fu">prep</span>()</span></code></pre></div>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" tabindex="-1"></a><span class="fu">bake</span>(rec_4, <span class="fu">head</span>(training_set, <span class="dv">4</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 6
##   Power Gas     Region             Brand                        Exposure ClaimNb
##   &lt;fct&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;fct&gt;                           &lt;dbl&gt;   &lt;int&gt;
## 1 g     Diesel  Aquitaine          Japanese (except Nissan) or…     0.84       0
## 2 f     Regular Nord-Pas-de-Calais Japanese (except Nissan) or…     0.52       0
## 3 f     Regular Nord-Pas-de-Calais Japanese (except Nissan) or…     0.45       0
## 4 g     Diesel  Pays-de-la-Loire   Japanese (except Nissan) or…     0.15       0</code></pre>
<p>Along with the <em>workflows</em> package, we can define a whole ..
workflow. This will only define the workflow. No fit is done at this
point</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" tabindex="-1"></a>m4_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb130-2"><a href="#cb130-2" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>)</span>
<span id="cb130-3"><a href="#cb130-3" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" tabindex="-1"></a>rec_4 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb130-5"><a href="#cb130-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb130-6"><a href="#cb130-6" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb130-7"><a href="#cb130-7" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb130-8"><a href="#cb130-8" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>)</span>
<span id="cb130-9"><a href="#cb130-9" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" tabindex="-1"></a></span>
<span id="cb130-11"><a href="#cb130-11" tabindex="-1"></a>m4_wflow <span class="ot">&lt;-</span> </span>
<span id="cb130-12"><a href="#cb130-12" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb130-13"><a href="#cb130-13" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_4) <span class="sc">%&gt;%</span></span>
<span id="cb130-14"><a href="#cb130-14" tabindex="-1"></a>  <span class="fu">add_model</span>(m4_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure))) <span class="co"># Formula of the model</span></span>
<span id="cb130-15"><a href="#cb130-15" tabindex="-1"></a>  </span>
<span id="cb130-16"><a href="#cb130-16" tabindex="-1"></a>m4_wflow</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: poisson_reg()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 4 Recipe Steps
## 
## • step_relevel()
## • step_relevel()
## • step_relevel()
## • step_relevel()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Poisson Regression Model Specification (regression)
## 
## Computational engine: glm</code></pre>
<p>We can fit, using the function fit.</p>
<p>The fit will consist in “baking” the data using the provided recipe,
and estimate the coefficients of the GLM</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" tabindex="-1"></a>m4_fit <span class="ot">&lt;-</span> <span class="fu">fit</span>(m4_wflow, <span class="at">data =</span> training_set)</span></code></pre></div>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" tabindex="-1"></a><span class="co"># extract_fit_engine(m4_fit) is the GLM object</span></span>
<span id="cb133-2"><a href="#cb133-2" tabindex="-1"></a><span class="co"># We can call the summary function on it</span></span>
<span id="cb133-3"><a href="#cb133-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m4_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ Power + Gas + Region + Brand + 
##     offset(log(Exposure)), family = stats::poisson, data = data)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92738    0.02686 -108.980  &lt; 2e-16
## Powere                                   0.08199    0.03121    2.627 0.008622
## Powerf                                   0.08333    0.03058    2.725 0.006430
## Powerg                                   0.04901    0.03044    1.610 0.107353
## Powerh                                   0.08583    0.04350    1.973 0.048475
## Poweri                                   0.18977    0.04841    3.920 8.87e-05
## Powerj                                   0.18583    0.04873    3.814 0.000137
## Powerk                                   0.20036    0.06432    3.115 0.001839
## Powerl                                   0.10847    0.09418    1.152 0.249470
## Powerm                                   0.24356    0.13330    1.827 0.067683
## Powern                                   0.20713    0.15903    1.302 0.192752
## Powero                                   0.26127    0.15324    1.705 0.088208
## GasDiesel                                0.12636    0.01886    6.700 2.09e-11
## RegionAquitaine                          0.17098    0.03795    4.506 6.62e-06
## RegionBasse-Normandie                    0.11350    0.05389    2.106 0.035185
## RegionBretagne                           0.04931    0.02954    1.670 0.095010
## RegionHaute-Normandie                    0.13236    0.07685    1.722 0.085024
## RegionIle-de-France                      0.38849    0.02835   13.702  &lt; 2e-16
## RegionLimousin                           0.41227    0.07692    5.360 8.34e-08
## RegionNord-Pas-de-Calais                 0.31214    0.03946    7.910 2.58e-15
## RegionPays-de-la-Loire                   0.15946    0.03129    5.096 3.46e-07
## RegionPoitou-Charentes                   0.16466    0.04142    3.975 7.03e-05
## BrandFiat                                0.09812    0.04380    2.240 0.025061
## BrandJapanese (except Nissan) or Korean -0.19473    0.03059   -6.365 1.95e-10
## BrandMercedes, Chrysler or BMW           0.07159    0.04424    1.618 0.105662
## BrandOpel, General Motors or Ford        0.14284    0.02983    4.788 1.68e-06
## Brandother                               0.03085    0.05674    0.544 0.586670
## BrandVolkswagen, Audi, Skoda or Seat     0.14182    0.03169    4.476 7.62e-06
##                                            
## (Intercept)                             ***
## Powere                                  ** 
## Powerf                                  ** 
## Powerg                                     
## Powerh                                  *  
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                  .  
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## RegionAquitaine                         ***
## RegionBasse-Normandie                   *  
## RegionBretagne                          .  
## RegionHaute-Normandie                   .  
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  ***
## RegionPoitou-Charentes                  ***
## BrandFiat                               *  
## BrandJapanese (except Nissan) or Korean ***
## BrandMercedes, Chrysler or BMW             
## BrandOpel, General Motors or Ford       ***
## Brandother                                 
## BrandVolkswagen, Audi, Skoda or Seat    ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83916  on 328664  degrees of freedom
## AIC: 108979
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>What if we want to predict claim frequencies from the testing set
?</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" tabindex="-1"></a><span class="fu">predict</span>(m4_fit, <span class="fu">head</span>(testing_set, <span class="dv">4</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 1
##     .pred
##     &lt;dbl&gt;
## 1 0.00561
## 2 0.00261
## 3 0.0613 
## 4 0.0134</code></pre>
<p>Do the predictions match what we’ve done before ?</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">predict</span>(m4_fit, testing_set) <span class="sc">-</span> <span class="fu">predict</span>(m1, testing_set, <span class="at">type=</span><span class="st">&quot;response&quot;</span>)))</span></code></pre></div>
<pre><code>## [1] 3.981537e-14</code></pre>
<p>What if the new data comes in as a text file ? Do we need to specify
what variables are factors ?</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" tabindex="-1"></a>new_data <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb139-2"><a href="#cb139-2" tabindex="-1"></a>    <span class="st">&quot;Exposure&quot;</span> <span class="ot">=</span> <span class="fl">0.8</span>,</span>
<span id="cb139-3"><a href="#cb139-3" tabindex="-1"></a>    <span class="st">&quot;Power&quot;</span> <span class="ot">=</span> <span class="st">&#39;f&#39;</span>,</span>
<span id="cb139-4"><a href="#cb139-4" tabindex="-1"></a>    <span class="st">&quot;Brand&quot;</span> <span class="ot">=</span> <span class="st">&quot;other&quot;</span>,</span>
<span id="cb139-5"><a href="#cb139-5" tabindex="-1"></a>    <span class="st">&quot;Gas&quot;</span> <span class="ot">=</span> <span class="st">&quot;Regular&quot;</span>,</span>
<span id="cb139-6"><a href="#cb139-6" tabindex="-1"></a>    <span class="st">&quot;Region&quot;</span> <span class="ot">=</span> <span class="st">&quot;Centre&quot;</span></span>
<span id="cb139-7"><a href="#cb139-7" tabindex="-1"></a>    )</span>
<span id="cb139-8"><a href="#cb139-8" tabindex="-1"></a></span>
<span id="cb139-9"><a href="#cb139-9" tabindex="-1"></a><span class="fu">predict</span>(m4_fit, new_data)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 1
##    .pred
##    &lt;dbl&gt;
## 1 0.0480</code></pre>
</div>
<div id="build-model-with-all-features" class="section level2">
<h2>Build Model with all features</h2>
<p>Now that we have understood how to build GLM models with workflows
and recipes, we can use all the variables from the dataset. We will also
include some interaction terms.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" tabindex="-1"></a>rec_5 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb141-2"><a href="#cb141-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-3"><a href="#cb141-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-4"><a href="#cb141-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-5"><a href="#cb141-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) </span>
<span id="cb141-6"><a href="#cb141-6" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" tabindex="-1"></a>m5_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb141-8"><a href="#cb141-8" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb141-9"><a href="#cb141-9" tabindex="-1"></a></span>
<span id="cb141-10"><a href="#cb141-10" tabindex="-1"></a>m5_wflow <span class="ot">&lt;-</span> </span>
<span id="cb141-11"><a href="#cb141-11" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-12"><a href="#cb141-12" tabindex="-1"></a>  <span class="fu">add_model</span>(m5_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> </span>
<span id="cb141-13"><a href="#cb141-13" tabindex="-1"></a>                                        Power <span class="sc">+</span> </span>
<span id="cb141-14"><a href="#cb141-14" tabindex="-1"></a>                                        Gas <span class="sc">+</span> </span>
<span id="cb141-15"><a href="#cb141-15" tabindex="-1"></a>                                        Region <span class="sc">+</span> </span>
<span id="cb141-16"><a href="#cb141-16" tabindex="-1"></a>                                        Brand <span class="sc">+</span> </span>
<span id="cb141-17"><a href="#cb141-17" tabindex="-1"></a>                                        Gas <span class="sc">*</span> Power <span class="sc">+</span> </span>
<span id="cb141-18"><a href="#cb141-18" tabindex="-1"></a>                                        Gas <span class="sc">*</span> Region) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb141-19"><a href="#cb141-19" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_5)</span>
<span id="cb141-20"><a href="#cb141-20" tabindex="-1"></a>m5_fit <span class="ot">=</span> m5_wflow <span class="sc">%&gt;%</span> <span class="fu">fit</span>(training_set)</span></code></pre></div>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m5_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + Power + 
##     Gas + Region + Brand + Gas * Power + Gas * Region, family = stats::poisson, 
##     data = data)
## 
## Coefficients:
##                                          Estimate Std. Error z value Pr(&gt;|z|)
## (Intercept)                             -2.925703   0.031537 -92.769  &lt; 2e-16
## Powere                                   0.033507   0.040333   0.831 0.406109
## Powerf                                   0.012188   0.043242   0.282 0.778054
## Powerg                                   0.118517   0.037132   3.192 0.001414
## Powerh                                   0.179694   0.068533   2.622 0.008741
## Poweri                                   0.230044   0.055140   4.172 3.02e-05
## Powerj                                   0.276424   0.064733   4.270 1.95e-05
## Powerk                                   0.226365   0.085561   2.646 0.008153
## Powerl                                   0.114533   0.179604   0.638 0.523670
## Powerm                                   0.238417   0.149455   1.595 0.110656
## Powern                                   0.223722   0.169844   1.317 0.187765
## Powero                                   0.343410   0.167267   2.053 0.040066
## GasDiesel                                0.141161   0.059528   2.371 0.017724
## RegionAquitaine                          0.142682   0.055834   2.555 0.010605
## RegionBasse-Normandie                    0.204736   0.076210   2.686 0.007221
## RegionBretagne                          -0.001434   0.043719  -0.033 0.973835
## RegionHaute-Normandie                    0.020488   0.123979   0.165 0.868747
## RegionIle-de-France                      0.372615   0.037102  10.043  &lt; 2e-16
## RegionLimousin                           0.444501   0.119070   3.733 0.000189
## RegionNord-Pas-de-Calais                 0.320808   0.060087   5.339 9.34e-08
## RegionPays-de-la-Loire                   0.117122   0.045738   2.561 0.010445
## RegionPoitou-Charentes                   0.136912   0.061250   2.235 0.025398
## BrandFiat                                0.108400   0.043906   2.469 0.013553
## BrandJapanese (except Nissan) or Korean -0.181479   0.030968  -5.860 4.62e-09
## BrandMercedes, Chrysler or BMW           0.096779   0.044829   2.159 0.030862
## BrandOpel, General Motors or Ford        0.142572   0.030202   4.721 2.35e-06
## Brandother                               0.040862   0.056867   0.719 0.472422
## BrandVolkswagen, Audi, Skoda or Seat     0.135868   0.032029   4.242 2.22e-05
## Powere:GasDiesel                         0.067126   0.067703   0.991 0.321452
## Powerf:GasDiesel                         0.075485   0.068347   1.104 0.269404
## Powerg:GasDiesel                        -0.167859   0.067031  -2.504 0.012273
## Powerh:GasDiesel                        -0.165573   0.094214  -1.757 0.078846
## Poweri:GasDiesel                        -0.176213   0.113816  -1.548 0.121568
## Powerj:GasDiesel                        -0.209747   0.100222  -2.093 0.036364
## Powerk:GasDiesel                        -0.082856   0.131019  -0.632 0.527129
## Powerl:GasDiesel                        -0.051140   0.212049  -0.241 0.809422
## Powerm:GasDiesel                        -0.052936   0.317645  -0.167 0.867645
## Powern:GasDiesel                        -0.136114   0.480786  -0.283 0.777094
## Powero:GasDiesel                        -0.453228   0.416262  -1.089 0.276240
## GasDiesel:RegionAquitaine                0.050226   0.075266   0.667 0.504568
## GasDiesel:RegionBasse-Normandie         -0.172397   0.107713  -1.601 0.109482
## GasDiesel:RegionBretagne                 0.096041   0.059199   1.622 0.104729
## GasDiesel:RegionHaute-Normandie          0.186670   0.157776   1.183 0.236755
## GasDiesel:RegionIle-de-France            0.021561   0.053509   0.403 0.686993
## GasDiesel:RegionLimousin                -0.054187   0.155585  -0.348 0.727628
## GasDiesel:RegionNord-Pas-de-Calais      -0.016111   0.078874  -0.204 0.838152
## GasDiesel:RegionPays-de-la-Loire         0.078422   0.062565   1.253 0.210039
## GasDiesel:RegionPoitou-Charentes         0.052481   0.083034   0.632 0.527355
##                                            
## (Intercept)                             ***
## Powere                                     
## Powerf                                     
## Powerg                                  ** 
## Powerh                                  ** 
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                     
## Powern                                     
## Powero                                  *  
## GasDiesel                               *  
## RegionAquitaine                         *  
## RegionBasse-Normandie                   ** 
## RegionBretagne                             
## RegionHaute-Normandie                      
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  *  
## RegionPoitou-Charentes                  *  
## BrandFiat                               *  
## BrandJapanese (except Nissan) or Korean ***
## BrandMercedes, Chrysler or BMW          *  
## BrandOpel, General Motors or Ford       ***
## Brandother                                 
## BrandVolkswagen, Audi, Skoda or Seat    ***
## Powere:GasDiesel                           
## Powerf:GasDiesel                           
## Powerg:GasDiesel                        *  
## Powerh:GasDiesel                        .  
## Poweri:GasDiesel                           
## Powerj:GasDiesel                        *  
## Powerk:GasDiesel                           
## Powerl:GasDiesel                           
## Powerm:GasDiesel                           
## Powern:GasDiesel                           
## Powero:GasDiesel                           
## GasDiesel:RegionAquitaine                  
## GasDiesel:RegionBasse-Normandie            
## GasDiesel:RegionBretagne                   
## GasDiesel:RegionHaute-Normandie            
## GasDiesel:RegionIle-de-France              
## GasDiesel:RegionLimousin                   
## GasDiesel:RegionNord-Pas-de-Calais         
## GasDiesel:RegionPays-de-la-Loire           
## GasDiesel:RegionPoitou-Charentes           
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83870  on 328644  degrees of freedom
## AIC: 108973
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<div id="cross-validation" class="section level3">
<h3>Cross-validation</h3>
<p>We will use cross-validation to find the relevant features to keep
and how to bin the variables.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" tabindex="-1"></a>folds <span class="ot">=</span> training_set <span class="sc">%&gt;%</span> <span class="fu">vfold_cv</span>(<span class="at">strata =</span> ClaimNb, <span class="at">v =</span> <span class="dv">5</span>)</span></code></pre></div>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">fit_resamples</span>(m5_wflow,</span>
<span id="cb145-2"><a href="#cb145-2" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb145-3"><a href="#cb145-3" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span></code></pre></div>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" tabindex="-1"></a><span class="co"># Collect metrics and format the &#39;mean&#39; and &#39;std_err&#39; columns for more decimal places</span></span>
<span id="cb146-2"><a href="#cb146-2" tabindex="-1"></a><span class="fu">collect_metrics</span>(res) <span class="sc">%&gt;%</span></span>
<span id="cb146-3"><a href="#cb146-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb146-4"><a href="#cb146-4" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb146-5"><a href="#cb146-5" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb146-6"><a href="#cb146-6" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165817     5 0.001183 Preprocessor1_Model1</code></pre>
</div>
<div id="without-interactions" class="section level3">
<h3>Without interactions</h3>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" tabindex="-1"></a>rec_6 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb148-2"><a href="#cb148-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-3"><a href="#cb148-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-4"><a href="#cb148-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-5"><a href="#cb148-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) </span>
<span id="cb148-6"><a href="#cb148-6" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" tabindex="-1"></a>m6_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb148-8"><a href="#cb148-8" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb148-9"><a href="#cb148-9" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" tabindex="-1"></a>m6_wflow <span class="ot">&lt;-</span> </span>
<span id="cb148-11"><a href="#cb148-11" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb148-12"><a href="#cb148-12" tabindex="-1"></a>  <span class="fu">add_model</span>(m6_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb148-13"><a href="#cb148-13" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_6)</span>
<span id="cb148-14"><a href="#cb148-14" tabindex="-1"></a>m6_fit <span class="ot">=</span> m6_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb148-15"><a href="#cb148-15" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span></code></pre></div>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">fit_resamples</span>(m6_wflow,</span>
<span id="cb149-2"><a href="#cb149-2" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb149-3"><a href="#cb149-3" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb149-4"><a href="#cb149-4" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" tabindex="-1"></a><span class="co"># Collect metrics and format the &#39;mean&#39; and &#39;std_err&#39; columns for more decimal places</span></span>
<span id="cb149-6"><a href="#cb149-6" tabindex="-1"></a><span class="fu">collect_metrics</span>(res) <span class="sc">%&gt;%</span></span>
<span id="cb149-7"><a href="#cb149-7" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb149-8"><a href="#cb149-8" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb149-9"><a href="#cb149-9" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb149-10"><a href="#cb149-10" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165793     5 0.001202 Preprocessor1_Model1</code></pre>
<p>We will not keep the interactions for now.</p>
<p>We can now try to merge some of the levels that appear to be not
significantly different.</p>
</div>
<div id="group-some-brands" class="section level3">
<h3>Group some Brands</h3>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" tabindex="-1"></a>rec_7 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb151-2"><a href="#cb151-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-3"><a href="#cb151-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-4"><a href="#cb151-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-5"><a href="#cb151-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-6"><a href="#cb151-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb151-7"><a href="#cb151-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb151-8"><a href="#cb151-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb151-9"><a href="#cb151-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) </span>
<span id="cb151-10"><a href="#cb151-10" tabindex="-1"></a></span>
<span id="cb151-11"><a href="#cb151-11" tabindex="-1"></a>m7_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb151-12"><a href="#cb151-12" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb151-13"><a href="#cb151-13" tabindex="-1"></a></span>
<span id="cb151-14"><a href="#cb151-14" tabindex="-1"></a>m7_wflow <span class="ot">&lt;-</span> </span>
<span id="cb151-15"><a href="#cb151-15" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb151-16"><a href="#cb151-16" tabindex="-1"></a>  <span class="fu">add_model</span>(m7_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb151-17"><a href="#cb151-17" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_7)</span>
<span id="cb151-18"><a href="#cb151-18" tabindex="-1"></a></span>
<span id="cb151-19"><a href="#cb151-19" tabindex="-1"></a>res7 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m7_wflow,</span>
<span id="cb151-20"><a href="#cb151-20" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb151-21"><a href="#cb151-21" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb151-22"><a href="#cb151-22" tabindex="-1"></a><span class="fu">collect_metrics</span>(res7) <span class="sc">%&gt;%</span></span>
<span id="cb151-23"><a href="#cb151-23" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb151-24"><a href="#cb151-24" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb151-25"><a href="#cb151-25" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb151-26"><a href="#cb151-26" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165781     5 0.001197 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" tabindex="-1"></a>m7_fit <span class="ot">=</span> m7_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb153-2"><a href="#cb153-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb153-3"><a href="#cb153-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m7_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92698    0.02673 -109.511  &lt; 2e-16
## Powere                                   0.08818    0.03101    2.843 0.004465
## Powerf                                   0.08505    0.03050    2.789 0.005293
## Powerg                                   0.04737    0.03029    1.564 0.117856
## Powerh                                   0.07704    0.04330    1.779 0.075194
## Poweri                                   0.17928    0.04796    3.738 0.000186
## Powerj                                   0.17717    0.04832    3.666 0.000246
## Powerk                                   0.18850    0.06378    2.956 0.003121
## Powerl                                   0.08957    0.09278    0.965 0.334343
## Powerm                                   0.20938    0.13060    1.603 0.108906
## Powern                                   0.18597    0.15818    1.176 0.239711
## Powero                                   0.25419    0.15298    1.662 0.096606
## GasDiesel                                0.12530    0.01879    6.669 2.57e-11
## RegionAquitaine                          0.17122    0.03794    4.512 6.41e-06
## RegionBasse-Normandie                    0.11234    0.05388    2.085 0.037085
## RegionBretagne                           0.04948    0.02953    1.676 0.093825
## RegionHaute-Normandie                    0.13115    0.07685    1.707 0.087875
## RegionIle-de-France                      0.38793    0.02835   13.684  &lt; 2e-16
## RegionLimousin                           0.41228    0.07692    5.360 8.31e-08
## RegionNord-Pas-de-Calais                 0.31337    0.03946    7.942 1.99e-15
## RegionPays-de-la-Loire                   0.15962    0.03129    5.102 3.37e-07
## RegionPoitou-Charentes                   0.16473    0.04142    3.977 6.96e-05
## BrandA                                   0.11697    0.02009    5.824 5.76e-09
## BrandJapanese (except Nissan) or Korean -0.19147    0.03054   -6.270 3.62e-10
##                                            
## (Intercept)                             ***
## Powere                                  ** 
## Powerf                                  ** 
## Powerg                                     
## Powerh                                  .  
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                     
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## RegionAquitaine                         ***
## RegionBasse-Normandie                   *  
## RegionBretagne                          .  
## RegionHaute-Normandie                   .  
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  ***
## RegionPoitou-Charentes                  ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83922  on 328668  degrees of freedom
## AIC: 108976
## 
## Number of Fisher Scoring iterations: 6</code></pre>
</div>
<div id="group-some-levels-of-power" class="section level3">
<h3>Group some levels of Power</h3>
<p>For example, one could regroup levels e-f-g-h of variable power.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" tabindex="-1"></a>rec_8 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb155-2"><a href="#cb155-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-3"><a href="#cb155-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-4"><a href="#cb155-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-5"><a href="#cb155-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-6"><a href="#cb155-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb155-7"><a href="#cb155-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb155-8"><a href="#cb155-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb155-9"><a href="#cb155-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb155-10"><a href="#cb155-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>)))</span>
<span id="cb155-11"><a href="#cb155-11" tabindex="-1"></a>m8_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb155-12"><a href="#cb155-12" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb155-13"><a href="#cb155-13" tabindex="-1"></a></span>
<span id="cb155-14"><a href="#cb155-14" tabindex="-1"></a>m8_wflow <span class="ot">&lt;-</span> </span>
<span id="cb155-15"><a href="#cb155-15" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb155-16"><a href="#cb155-16" tabindex="-1"></a>  <span class="fu">add_model</span>(m8_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb155-17"><a href="#cb155-17" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_8)</span>
<span id="cb155-18"><a href="#cb155-18" tabindex="-1"></a></span>
<span id="cb155-19"><a href="#cb155-19" tabindex="-1"></a>res8 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m8_wflow,</span>
<span id="cb155-20"><a href="#cb155-20" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb155-21"><a href="#cb155-21" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb155-22"><a href="#cb155-22" tabindex="-1"></a><span class="fu">collect_metrics</span>(res8) <span class="sc">%&gt;%</span></span>
<span id="cb155-23"><a href="#cb155-23" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb155-24"><a href="#cb155-24" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb155-25"><a href="#cb155-25" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb155-26"><a href="#cb155-26" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165777     5 0.001192 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" tabindex="-1"></a>m8_fit <span class="ot">=</span> m8_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb157-2"><a href="#cb157-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb157-3"><a href="#cb157-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m8_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92788    0.02670 -109.661  &lt; 2e-16
## Powere-f-g-h                             0.07249    0.02622    2.765 0.005700
## Poweri                                   0.17905    0.04796    3.733 0.000189
## Powerj                                   0.17635    0.04831    3.651 0.000262
## Powerk                                   0.18774    0.06377    2.944 0.003239
## Powerl                                   0.08816    0.09276    0.950 0.341908
## Powerm                                   0.20891    0.13060    1.600 0.109675
## Powern                                   0.18587    0.15817    1.175 0.239950
## Powero                                   0.25478    0.15298    1.666 0.095812
## GasDiesel                                0.12878    0.01851    6.958 3.46e-12
## RegionAquitaine                          0.17216    0.03794    4.538 5.68e-06
## RegionBasse-Normandie                    0.11252    0.05388    2.088 0.036779
## RegionBretagne                           0.05029    0.02953    1.703 0.088492
## RegionHaute-Normandie                    0.13078    0.07685    1.702 0.088785
## RegionIle-de-France                      0.38866    0.02834   13.714  &lt; 2e-16
## RegionLimousin                           0.41220    0.07691    5.359 8.36e-08
## RegionNord-Pas-de-Calais                 0.31441    0.03945    7.971 1.58e-15
## RegionPays-de-la-Loire                   0.15962    0.03129    5.102 3.37e-07
## RegionPoitou-Charentes                   0.16461    0.04141    3.975 7.04e-05
## BrandA                                   0.11735    0.01995    5.882 4.06e-09
## BrandJapanese (except Nissan) or Korean -0.19355    0.03036   -6.375 1.83e-10
##                                            
## (Intercept)                             ***
## Powere-f-g-h                            ** 
## Poweri                                  ***
## Powerj                                  ***
## Powerk                                  ** 
## Powerl                                     
## Powerm                                     
## Powern                                     
## Powero                                  .  
## GasDiesel                               ***
## RegionAquitaine                         ***
## RegionBasse-Normandie                   *  
## RegionBretagne                          .  
## RegionHaute-Normandie                   .  
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  ***
## RegionPoitou-Charentes                  ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83924  on 328671  degrees of freedom
## AIC: 108973
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>Let us try a different regrouping:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" tabindex="-1"></a>rec_8 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb159-2"><a href="#cb159-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb159-3"><a href="#cb159-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb159-4"><a href="#cb159-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb159-5"><a href="#cb159-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb159-6"><a href="#cb159-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb159-7"><a href="#cb159-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb159-8"><a href="#cb159-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb159-9"><a href="#cb159-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb159-10"><a href="#cb159-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, <span class="st">&quot;d-e&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;d&quot;</span>, <span class="st">&quot;e&quot;</span>), <span class="st">&quot;f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>))) </span>
<span id="cb159-11"><a href="#cb159-11" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" tabindex="-1"></a>m8_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb159-13"><a href="#cb159-13" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb159-14"><a href="#cb159-14" tabindex="-1"></a></span>
<span id="cb159-15"><a href="#cb159-15" tabindex="-1"></a>m8_wflow <span class="ot">&lt;-</span> </span>
<span id="cb159-16"><a href="#cb159-16" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb159-17"><a href="#cb159-17" tabindex="-1"></a>  <span class="fu">add_model</span>(m8_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb159-18"><a href="#cb159-18" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_8)</span>
<span id="cb159-19"><a href="#cb159-19" tabindex="-1"></a></span>
<span id="cb159-20"><a href="#cb159-20" tabindex="-1"></a>res8 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m8_wflow,</span>
<span id="cb159-21"><a href="#cb159-21" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb159-22"><a href="#cb159-22" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb159-23"><a href="#cb159-23" tabindex="-1"></a><span class="fu">collect_metrics</span>(res8) <span class="sc">%&gt;%</span></span>
<span id="cb159-24"><a href="#cb159-24" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb159-25"><a href="#cb159-25" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb159-26"><a href="#cb159-26" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb159-27"><a href="#cb159-27" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165787     5 0.001188 Preprocessor1_Model1</code></pre>
<p>We can see that with the new regrouping, its cross-validation error
increases. Finally, let us regroup the some other levels</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" tabindex="-1"></a>rec_9 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb161-2"><a href="#cb161-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-3"><a href="#cb161-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-4"><a href="#cb161-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-5"><a href="#cb161-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb161-6"><a href="#cb161-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>,</span>
<span id="cb161-7"><a href="#cb161-7" tabindex="-1"></a>                                                           <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb161-8"><a href="#cb161-8" tabindex="-1"></a>                                                           <span class="st">&quot;other&quot;</span>, </span>
<span id="cb161-9"><a href="#cb161-9" tabindex="-1"></a>                                                           <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb161-10"><a href="#cb161-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb161-11"><a href="#cb161-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb161-12"><a href="#cb161-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb161-13"><a href="#cb161-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb161-14"><a href="#cb161-14" tabindex="-1"></a>                                             )) </span>
<span id="cb161-15"><a href="#cb161-15" tabindex="-1"></a></span>
<span id="cb161-16"><a href="#cb161-16" tabindex="-1"></a>m9_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb161-17"><a href="#cb161-17" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb161-18"><a href="#cb161-18" tabindex="-1"></a></span>
<span id="cb161-19"><a href="#cb161-19" tabindex="-1"></a>m9_wflow <span class="ot">&lt;-</span> </span>
<span id="cb161-20"><a href="#cb161-20" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb161-21"><a href="#cb161-21" tabindex="-1"></a>  <span class="fu">add_model</span>(m9_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb161-22"><a href="#cb161-22" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_9)</span>
<span id="cb161-23"><a href="#cb161-23" tabindex="-1"></a></span>
<span id="cb161-24"><a href="#cb161-24" tabindex="-1"></a>res9 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m9_wflow,</span>
<span id="cb161-25"><a href="#cb161-25" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb161-26"><a href="#cb161-26" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb161-27"><a href="#cb161-27" tabindex="-1"></a><span class="fu">collect_metrics</span>(res9) <span class="sc">%&gt;%</span></span>
<span id="cb161-28"><a href="#cb161-28" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb161-29"><a href="#cb161-29" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb161-30"><a href="#cb161-30" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb161-31"><a href="#cb161-31" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165762     5 0.001198 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" tabindex="-1"></a>m9_fit <span class="ot">=</span> m9_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb163-2"><a href="#cb163-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb163-3"><a href="#cb163-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m9_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                         Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                             -2.92713    0.02667 -109.742  &lt; 2e-16
## Powere-f-g-h                             0.07292    0.02621    2.782  0.00541
## Poweri-j-k-l-m                           0.17380    0.03441    5.051 4.40e-07
## Powern-o                                 0.22131    0.11122    1.990  0.04661
## GasDiesel                                0.12740    0.01839    6.929 4.22e-12
## RegionAquitaine                          0.17239    0.03793    4.545 5.50e-06
## RegionBasse-Normandie                    0.11241    0.05388    2.086  0.03694
## RegionBretagne                           0.05029    0.02952    1.703  0.08850
## RegionHaute-Normandie                    0.13038    0.07684    1.697  0.08973
## RegionIle-de-France                      0.38869    0.02833   13.719  &lt; 2e-16
## RegionLimousin                           0.41214    0.07691    5.359 8.39e-08
## RegionNord-Pas-de-Calais                 0.31459    0.03944    7.977 1.50e-15
## RegionPays-de-la-Loire                   0.15954    0.03129    5.099 3.41e-07
## RegionPoitou-Charentes                   0.16473    0.04141    3.978 6.96e-05
## BrandA                                   0.11675    0.01990    5.866 4.46e-09
## BrandJapanese (except Nissan) or Korean -0.19535    0.03016   -6.476 9.39e-11
##                                            
## (Intercept)                             ***
## Powere-f-g-h                            ** 
## Poweri-j-k-l-m                          ***
## Powern-o                                *  
## GasDiesel                               ***
## RegionAquitaine                         ***
## RegionBasse-Normandie                   *  
## RegionBretagne                          .  
## RegionHaute-Normandie                   .  
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## RegionPays-de-la-Loire                  ***
## RegionPoitou-Charentes                  ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83926  on 328676  degrees of freedom
## AIC: 108964
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>Let us now regroup some regions, e.g. Pays de la loire et
Poitou-Charentes for which coefficients are not so different.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb165-2"><a href="#cb165-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb165-3"><a href="#cb165-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb165-4"><a href="#cb165-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb165-5"><a href="#cb165-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb165-6"><a href="#cb165-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb165-7"><a href="#cb165-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb165-8"><a href="#cb165-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb165-9"><a href="#cb165-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb165-10"><a href="#cb165-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb165-11"><a href="#cb165-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb165-12"><a href="#cb165-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb165-13"><a href="#cb165-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb165-14"><a href="#cb165-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb165-15"><a href="#cb165-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb165-16"><a href="#cb165-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb165-17"><a href="#cb165-17" tabindex="-1"></a>                                                )) </span>
<span id="cb165-18"><a href="#cb165-18" tabindex="-1"></a></span>
<span id="cb165-19"><a href="#cb165-19" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb165-20"><a href="#cb165-20" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb165-21"><a href="#cb165-21" tabindex="-1"></a></span>
<span id="cb165-22"><a href="#cb165-22" tabindex="-1"></a>m10_wflow <span class="ot">&lt;-</span> </span>
<span id="cb165-23"><a href="#cb165-23" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb165-24"><a href="#cb165-24" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb165-25"><a href="#cb165-25" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb165-26"><a href="#cb165-26" tabindex="-1"></a></span>
<span id="cb165-27"><a href="#cb165-27" tabindex="-1"></a>res10 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m10_wflow,</span>
<span id="cb165-28"><a href="#cb165-28" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb165-29"><a href="#cb165-29" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb165-30"><a href="#cb165-30" tabindex="-1"></a><span class="fu">collect_metrics</span>(res10) <span class="sc">%&gt;%</span></span>
<span id="cb165-31"><a href="#cb165-31" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb165-32"><a href="#cb165-32" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb165-33"><a href="#cb165-33" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb165-34"><a href="#cb165-34" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165759     5 0.001198 Preprocessor1_Model1</code></pre>
</div>
</div>
<div id="consider-the-continuous-variables" class="section level2">
<h2>Consider the continuous variables</h2>
<p>Let us first add the variables without any preprocessing.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> DriverAge <span class="sc">+</span> CarAge <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb167-2"><a href="#cb167-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-3"><a href="#cb167-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-4"><a href="#cb167-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-5"><a href="#cb167-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-6"><a href="#cb167-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb167-7"><a href="#cb167-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb167-8"><a href="#cb167-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb167-9"><a href="#cb167-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb167-10"><a href="#cb167-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb167-11"><a href="#cb167-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb167-12"><a href="#cb167-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb167-13"><a href="#cb167-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb167-14"><a href="#cb167-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb167-15"><a href="#cb167-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb167-16"><a href="#cb167-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb167-17"><a href="#cb167-17" tabindex="-1"></a>                                                )) </span>
<span id="cb167-18"><a href="#cb167-18" tabindex="-1"></a></span>
<span id="cb167-19"><a href="#cb167-19" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb167-20"><a href="#cb167-20" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb167-21"><a href="#cb167-21" tabindex="-1"></a></span>
<span id="cb167-22"><a href="#cb167-22" tabindex="-1"></a>m10_wflow <span class="ot">&lt;-</span> </span>
<span id="cb167-23"><a href="#cb167-23" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb167-24"><a href="#cb167-24" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb167-25"><a href="#cb167-25" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb167-26"><a href="#cb167-26" tabindex="-1"></a></span>
<span id="cb167-27"><a href="#cb167-27" tabindex="-1"></a>res10 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m10_wflow,</span>
<span id="cb167-28"><a href="#cb167-28" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb167-29"><a href="#cb167-29" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb167-30"><a href="#cb167-30" tabindex="-1"></a><span class="fu">collect_metrics</span>(res10) <span class="sc">%&gt;%</span></span>
<span id="cb167-31"><a href="#cb167-31" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb167-32"><a href="#cb167-32" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb167-33"><a href="#cb167-33" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb167-34"><a href="#cb167-34" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165338     5 0.001180 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" tabindex="-1"></a>m10_fit <span class="ot">=</span> m10_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb169-2"><a href="#cb169-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb169-3"><a href="#cb169-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m10_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                           Estimate Std. Error z value Pr(&gt;|z|)
## (Intercept)                             -2.3259147  0.0449218 -51.777  &lt; 2e-16
## DriverAge                               -0.0098563  0.0006363 -15.489  &lt; 2e-16
## CarAge                                  -0.0122924  0.0018583  -6.615 3.72e-11
## Powere-f-g-h                             0.0752926  0.0262274   2.871  0.00409
## Poweri-j-k-l-m                           0.1930871  0.0343932   5.614 1.98e-08
## Powern-o                                 0.2358311  0.1112179   2.120  0.03397
## GasDiesel                                0.0836724  0.0186591   4.484 7.32e-06
## RegionA                                  0.1488080  0.0238067   6.251 4.09e-10
## RegionBasse-Normandie                    0.0948861  0.0539015   1.760  0.07835
## RegionBretagne                           0.0402349  0.0295613   1.361  0.17349
## RegionHaute-Normandie                    0.0947441  0.0768673   1.233  0.21774
## RegionIle-de-France                      0.3391864  0.0285335  11.887  &lt; 2e-16
## RegionLimousin                           0.3965140  0.0769311   5.154 2.55e-07
## RegionNord-Pas-de-Calais                 0.2519749  0.0396145   6.361 2.01e-10
## BrandA                                   0.0806791  0.0200033   4.033 5.50e-05
## BrandJapanese (except Nissan) or Korean -0.2521117  0.0316680  -7.961 1.71e-15
##                                            
## (Intercept)                             ***
## DriverAge                               ***
## CarAge                                  ***
## Powere-f-g-h                            ** 
## Poweri-j-k-l-m                          ***
## Powern-o                                *  
## GasDiesel                               ***
## RegionA                                 ***
## RegionBasse-Normandie                   .  
## RegionBretagne                             
## RegionHaute-Normandie                      
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83647  on 328676  degrees of freedom
## AIC: 108686
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>One possibility is to add polynomial terms. We then need to find the
optimal degree of the polynomial. For example, let us consider a
polynomial of degree 2 for DriverAge and a polynomial for CarAge.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> DriverAge <span class="sc">+</span> CarAge <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb171-2"><a href="#cb171-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-3"><a href="#cb171-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-4"><a href="#cb171-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-5"><a href="#cb171-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-6"><a href="#cb171-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb171-7"><a href="#cb171-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb171-8"><a href="#cb171-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb171-9"><a href="#cb171-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb171-10"><a href="#cb171-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb171-11"><a href="#cb171-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb171-12"><a href="#cb171-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb171-13"><a href="#cb171-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb171-14"><a href="#cb171-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb171-15"><a href="#cb171-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb171-16"><a href="#cb171-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb171-17"><a href="#cb171-17" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb171-18"><a href="#cb171-18" tabindex="-1"></a>    <span class="fu">step_poly</span>(DriverAge, <span class="at">degree=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb171-19"><a href="#cb171-19" tabindex="-1"></a>    <span class="fu">step_poly</span>(CarAge, <span class="at">degree=</span><span class="dv">2</span>) </span>
<span id="cb171-20"><a href="#cb171-20" tabindex="-1"></a></span>
<span id="cb171-21"><a href="#cb171-21" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb171-22"><a href="#cb171-22" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb171-23"><a href="#cb171-23" tabindex="-1"></a></span>
<span id="cb171-24"><a href="#cb171-24" tabindex="-1"></a>m11_wflow <span class="ot">&lt;-</span> </span>
<span id="cb171-25"><a href="#cb171-25" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb171-26"><a href="#cb171-26" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb171-27"><a href="#cb171-27" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb171-28"><a href="#cb171-28" tabindex="-1"></a></span>
<span id="cb171-29"><a href="#cb171-29" tabindex="-1"></a>res11 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m11_wflow,</span>
<span id="cb171-30"><a href="#cb171-30" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb171-31"><a href="#cb171-31" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb171-32"><a href="#cb171-32" tabindex="-1"></a><span class="fu">collect_metrics</span>(res11) <span class="sc">%&gt;%</span></span>
<span id="cb171-33"><a href="#cb171-33" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb171-34"><a href="#cb171-34" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb171-35"><a href="#cb171-35" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb171-36"><a href="#cb171-36" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.165069     5 0.001154 Preprocessor1_Model1</code></pre>
<p>We can change the degree. After several trials and errors, we can
find…</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> DriverAge <span class="sc">+</span> CarAge <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb173-2"><a href="#cb173-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-3"><a href="#cb173-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-4"><a href="#cb173-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-5"><a href="#cb173-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-6"><a href="#cb173-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb173-7"><a href="#cb173-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb173-8"><a href="#cb173-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb173-9"><a href="#cb173-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb173-10"><a href="#cb173-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb173-11"><a href="#cb173-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb173-12"><a href="#cb173-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb173-13"><a href="#cb173-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb173-14"><a href="#cb173-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb173-15"><a href="#cb173-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb173-16"><a href="#cb173-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb173-17"><a href="#cb173-17" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb173-18"><a href="#cb173-18" tabindex="-1"></a>    <span class="fu">step_poly</span>(DriverAge, <span class="at">degree=</span><span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb173-19"><a href="#cb173-19" tabindex="-1"></a>    <span class="fu">step_poly</span>(CarAge, <span class="at">degree=</span><span class="dv">2</span>) </span>
<span id="cb173-20"><a href="#cb173-20" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb173-21"><a href="#cb173-21" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb173-22"><a href="#cb173-22" tabindex="-1"></a></span>
<span id="cb173-23"><a href="#cb173-23" tabindex="-1"></a>m11_wflow <span class="ot">&lt;-</span> </span>
<span id="cb173-24"><a href="#cb173-24" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb173-25"><a href="#cb173-25" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb173-26"><a href="#cb173-26" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb173-27"><a href="#cb173-27" tabindex="-1"></a></span>
<span id="cb173-28"><a href="#cb173-28" tabindex="-1"></a>res11 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m11_wflow,</span>
<span id="cb173-29"><a href="#cb173-29" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb173-30"><a href="#cb173-30" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb173-31"><a href="#cb173-31" tabindex="-1"></a><span class="fu">collect_metrics</span>(res11) <span class="sc">%&gt;%</span></span>
<span id="cb173-32"><a href="#cb173-32" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb173-33"><a href="#cb173-33" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb173-34"><a href="#cb173-34" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb173-35"><a href="#cb173-35" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.164456     5 0.001170 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" tabindex="-1"></a>m11_fit <span class="ot">=</span> m11_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb175-2"><a href="#cb175-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb175-3"><a href="#cb175-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m11_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                          Estimate Std. Error  z value Pr(&gt;|z|)
## (Intercept)                              -2.93816    0.02757 -106.583  &lt; 2e-16
## Powere-f-g-h                              0.09047    0.02627    3.444 0.000572
## Poweri-j-k-l-m                            0.23014    0.03453    6.665 2.65e-11
## Powern-o                                  0.29075    0.11128    2.613 0.008982
## GasDiesel                                 0.11582    0.01877    6.170 6.81e-10
## RegionA                                   0.16658    0.02382    6.993 2.69e-12
## RegionBasse-Normandie                     0.08869    0.05391    1.645 0.099968
## RegionBretagne                            0.05251    0.02959    1.774 0.075986
## RegionHaute-Normandie                     0.12038    0.07688    1.566 0.117367
## RegionIle-de-France                       0.37560    0.02856   13.153  &lt; 2e-16
## RegionLimousin                            0.42372    0.07696    5.506 3.68e-08
## RegionNord-Pas-de-Calais                  0.27311    0.03962    6.893 5.46e-12
## BrandA                                    0.08714    0.02001    4.355 1.33e-05
## BrandJapanese (except Nissan) or Korean  -0.19633    0.03235   -6.069 1.29e-09
## DriverAge_poly_1                        -68.20369    5.04050  -13.531  &lt; 2e-16
## DriverAge_poly_2                         50.59479    4.72944   10.698  &lt; 2e-16
## DriverAge_poly_3                        -49.17063    4.67529  -10.517  &lt; 2e-16
## DriverAge_poly_4                         64.41172    4.63685   13.891  &lt; 2e-16
## DriverAge_poly_5                        -40.98919    4.62985   -8.853  &lt; 2e-16
## DriverAge_poly_6                         -2.04858    4.55047   -0.450 0.652572
## DriverAge_poly_7                         12.64854    4.57601    2.764 0.005708
## CarAge_poly_1                           -37.57043    5.99167   -6.270 3.60e-10
## CarAge_poly_2                           -32.83930    5.78218   -5.679 1.35e-08
##                                            
## (Intercept)                             ***
## Powere-f-g-h                            ***
## Poweri-j-k-l-m                          ***
## Powern-o                                ** 
## GasDiesel                               ***
## RegionA                                 ***
## RegionBasse-Normandie                   .  
## RegionBretagne                          .  
## RegionHaute-Normandie                      
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## DriverAge_poly_1                        ***
## DriverAge_poly_2                        ***
## DriverAge_poly_3                        ***
## DriverAge_poly_4                        ***
## DriverAge_poly_5                        ***
## DriverAge_poly_6                           
## DriverAge_poly_7                        ** 
## CarAge_poly_1                           ***
## CarAge_poly_2                           ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83049  on 328669  degrees of freedom
## AIC: 108102
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>Another possibility was to bin the continuous variables. For example,
here on DriverAge.</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> DriverAge <span class="sc">+</span> CarAge <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb177-2"><a href="#cb177-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-3"><a href="#cb177-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-4"><a href="#cb177-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-5"><a href="#cb177-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-6"><a href="#cb177-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb177-7"><a href="#cb177-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb177-8"><a href="#cb177-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb177-9"><a href="#cb177-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb177-10"><a href="#cb177-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb177-11"><a href="#cb177-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb177-12"><a href="#cb177-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb177-13"><a href="#cb177-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb177-14"><a href="#cb177-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb177-15"><a href="#cb177-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb177-16"><a href="#cb177-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb177-17"><a href="#cb177-17" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb177-18"><a href="#cb177-18" tabindex="-1"></a>    <span class="fu">step_discretize</span>(DriverAge, <span class="at">num_breaks=</span><span class="dv">25</span>, <span class="at">min_unique =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-19"><a href="#cb177-19" tabindex="-1"></a>    <span class="fu">step_poly</span>(CarAge, <span class="at">degree=</span><span class="dv">2</span>) </span>
<span id="cb177-20"><a href="#cb177-20" tabindex="-1"></a></span>
<span id="cb177-21"><a href="#cb177-21" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb177-22"><a href="#cb177-22" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb177-23"><a href="#cb177-23" tabindex="-1"></a></span>
<span id="cb177-24"><a href="#cb177-24" tabindex="-1"></a>m12_wflow <span class="ot">&lt;-</span> </span>
<span id="cb177-25"><a href="#cb177-25" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-26"><a href="#cb177-26" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb177-27"><a href="#cb177-27" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb177-28"><a href="#cb177-28" tabindex="-1"></a></span>
<span id="cb177-29"><a href="#cb177-29" tabindex="-1"></a>res12 <span class="ot">=</span> <span class="fu">fit_resamples</span>(m12_wflow,</span>
<span id="cb177-30"><a href="#cb177-30" tabindex="-1"></a>                    <span class="at">resamples =</span> folds,</span>
<span id="cb177-31"><a href="#cb177-31" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">metric_set</span>(poisson_log_loss))</span>
<span id="cb177-32"><a href="#cb177-32" tabindex="-1"></a><span class="fu">collect_metrics</span>(res12) <span class="sc">%&gt;%</span></span>
<span id="cb177-33"><a href="#cb177-33" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb177-34"><a href="#cb177-34" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, mean),</span>
<span id="cb177-35"><a href="#cb177-35" tabindex="-1"></a>    <span class="at">std_err =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.6f&quot;</span>, std_err)</span>
<span id="cb177-36"><a href="#cb177-36" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   .metric          .estimator mean         n std_err  .config             
##   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;               
## 1 poisson_log_loss standard   0.164667     5 0.001178 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" tabindex="-1"></a>m12_fit <span class="ot">=</span> m12_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb179-2"><a href="#cb179-2" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb179-3"><a href="#cb179-3" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">extract_fit_engine</span>(m12_fit))</span></code></pre></div>
<pre><code>## 
## Call:
## stats::glm(formula = ClaimNb ~ offset(log(Exposure)) + . - Exposure, 
##     family = stats::poisson, data = data)
## 
## Coefficients:
##                                          Estimate Std. Error z value Pr(&gt;|z|)
## (Intercept)                              -2.11868    0.03922 -54.018  &lt; 2e-16
## DriverAgebin02                           -0.58177    0.05028 -11.570  &lt; 2e-16
## DriverAgebin03                           -0.70481    0.05374 -13.115  &lt; 2e-16
## DriverAgebin04                           -0.84240    0.06912 -12.188  &lt; 2e-16
## DriverAgebin05                           -0.86425    0.05288 -16.345  &lt; 2e-16
## DriverAgebin06                           -0.91318    0.05279 -17.298  &lt; 2e-16
## DriverAgebin07                           -0.85164    0.06605 -12.895  &lt; 2e-16
## DriverAgebin08                           -0.93888    0.05247 -17.894  &lt; 2e-16
## DriverAgebin09                           -0.99082    0.06834 -14.499  &lt; 2e-16
## DriverAgebin10                           -0.90722    0.05181 -17.510  &lt; 2e-16
## DriverAgebin11                           -0.86824    0.05106 -17.005  &lt; 2e-16
## DriverAgebin12                           -0.81447    0.06418 -12.690  &lt; 2e-16
## DriverAgebin13                           -0.72332    0.04929 -14.675  &lt; 2e-16
## DriverAgebin14                           -0.78312    0.05005 -15.646  &lt; 2e-16
## DriverAgebin15                           -0.77665    0.06296 -12.336  &lt; 2e-16
## DriverAgebin16                           -0.74981    0.04827 -15.534  &lt; 2e-16
## DriverAgebin17                           -0.80149    0.06191 -12.947  &lt; 2e-16
## DriverAgebin18                           -0.81731    0.04954 -16.499  &lt; 2e-16
## DriverAgebin19                           -0.93745    0.05310 -17.654  &lt; 2e-16
## DriverAgebin20                           -0.92848    0.05666 -16.387  &lt; 2e-16
## DriverAgebin21                           -0.95575    0.05506 -17.360  &lt; 2e-16
## DriverAgebin22                           -0.93584    0.05975 -15.664  &lt; 2e-16
## DriverAgebin23                           -1.06331    0.05482 -19.398  &lt; 2e-16
## DriverAgebin24                           -1.00121    0.05389 -18.579  &lt; 2e-16
## DriverAgebin25                           -0.87647    0.05360 -16.352  &lt; 2e-16
## Powere-f-g-h                              0.09035    0.02626   3.441 0.000579
## Poweri-j-k-l-m                            0.23038    0.03452   6.673 2.50e-11
## Powern-o                                  0.28410    0.11129   2.553 0.010685
## GasDiesel                                 0.11118    0.01875   5.929 3.05e-09
## RegionA                                   0.16597    0.02382   6.967 3.25e-12
## RegionBasse-Normandie                     0.08993    0.05392   1.668 0.095334
## RegionBretagne                            0.04970    0.02958   1.680 0.092945
## RegionHaute-Normandie                     0.12089    0.07689   1.572 0.115868
## RegionIle-de-France                       0.37169    0.02855  13.020  &lt; 2e-16
## RegionLimousin                            0.41783    0.07696   5.429 5.66e-08
## RegionNord-Pas-de-Calais                  0.26672    0.03963   6.731 1.69e-11
## BrandA                                    0.08691    0.02001   4.343 1.41e-05
## BrandJapanese (except Nissan) or Korean  -0.19684    0.03235  -6.085 1.16e-09
## CarAge_poly_1                           -35.02851    5.98368  -5.854 4.80e-09
## CarAge_poly_2                           -33.42457    5.77456  -5.788 7.11e-09
##                                            
## (Intercept)                             ***
## DriverAgebin02                          ***
## DriverAgebin03                          ***
## DriverAgebin04                          ***
## DriverAgebin05                          ***
## DriverAgebin06                          ***
## DriverAgebin07                          ***
## DriverAgebin08                          ***
## DriverAgebin09                          ***
## DriverAgebin10                          ***
## DriverAgebin11                          ***
## DriverAgebin12                          ***
## DriverAgebin13                          ***
## DriverAgebin14                          ***
## DriverAgebin15                          ***
## DriverAgebin16                          ***
## DriverAgebin17                          ***
## DriverAgebin18                          ***
## DriverAgebin19                          ***
## DriverAgebin20                          ***
## DriverAgebin21                          ***
## DriverAgebin22                          ***
## DriverAgebin23                          ***
## DriverAgebin24                          ***
## DriverAgebin25                          ***
## Powere-f-g-h                            ***
## Poweri-j-k-l-m                          ***
## Powern-o                                *  
## GasDiesel                               ***
## RegionA                                 ***
## RegionBasse-Normandie                   .  
## RegionBretagne                          .  
## RegionHaute-Normandie                      
## RegionIle-de-France                     ***
## RegionLimousin                          ***
## RegionNord-Pas-de-Calais                ***
## BrandA                                  ***
## BrandJapanese (except Nissan) or Korean ***
## CarAge_poly_1                           ***
## CarAge_poly_2                           ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 84299  on 328691  degrees of freedom
## Residual deviance: 83139  on 328652  degrees of freedom
## AIC: 108226
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<p>We see that the polynomial approach has better performance compared
to binning the continuous variables.</p>
</div>
<div id="comparison-with-other-models" class="section level2">
<h2>Comparison with other models</h2>
<p>Note that we have NOT used the variable Density here. Let us use our
best model. We will use this as comparison for our future sessions.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(ClaimNb <span class="sc">~</span> DriverAge <span class="sc">+</span> CarAge <span class="sc">+</span> Power <span class="sc">+</span> Gas <span class="sc">+</span> Region <span class="sc">+</span> Brand <span class="sc">+</span> Exposure, <span class="at">data =</span> training_set) <span class="sc">%&gt;%</span> <span class="co"># Which columns do we need ?</span></span>
<span id="cb181-2"><a href="#cb181-2" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Power, <span class="at">ref_level =</span> <span class="st">&quot;d&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb181-3"><a href="#cb181-3" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Gas, <span class="at">ref_level =</span> <span class="st">&quot;Regular&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb181-4"><a href="#cb181-4" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Region, <span class="at">ref_level =</span> <span class="st">&quot;Centre&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb181-5"><a href="#cb181-5" tabindex="-1"></a>    <span class="fu">step_relevel</span>(Brand, <span class="at">ref_level =</span> <span class="st">&quot;Renault, Nissan or Citroen&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb181-6"><a href="#cb181-6" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Brand =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Brand, <span class="at">A =</span> <span class="fu">c</span>(<span class="st">&quot;Fiat&quot;</span>, <span class="st">&quot;Mercedes, Chrysler or BMW&quot;</span>, </span>
<span id="cb181-7"><a href="#cb181-7" tabindex="-1"></a>                                                     <span class="st">&quot;Opel, General Motors or Ford&quot;</span>,</span>
<span id="cb181-8"><a href="#cb181-8" tabindex="-1"></a>                                                     <span class="st">&quot;other&quot;</span>, </span>
<span id="cb181-9"><a href="#cb181-9" tabindex="-1"></a>                                                     <span class="st">&quot;Volkswagen, Audi, Skoda or Seat&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb181-10"><a href="#cb181-10" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Power =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Power, </span>
<span id="cb181-11"><a href="#cb181-11" tabindex="-1"></a>                                                 <span class="st">&quot;e-f-g-h&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;e&quot;</span>, <span class="st">&quot;f&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;h&quot;</span>),</span>
<span id="cb181-12"><a href="#cb181-12" tabindex="-1"></a>                                                 <span class="st">&quot;i-j-k-l-m&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;j&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;m&quot;</span>),</span>
<span id="cb181-13"><a href="#cb181-13" tabindex="-1"></a>                                                 <span class="st">&quot;n-o&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;o&quot;</span>)</span>
<span id="cb181-14"><a href="#cb181-14" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb181-15"><a href="#cb181-15" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Region =</span> forcats<span class="sc">::</span><span class="fu">fct_collapse</span>(Region, </span>
<span id="cb181-16"><a href="#cb181-16" tabindex="-1"></a>                                                 <span class="st">&quot;A&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Pays-de-la-Loire&quot;</span>, <span class="st">&quot;Poitou-Charentes&quot;</span>, <span class="st">&quot;Aquitaine&quot;</span>)</span>
<span id="cb181-17"><a href="#cb181-17" tabindex="-1"></a>                                                )) <span class="sc">%&gt;%</span></span>
<span id="cb181-18"><a href="#cb181-18" tabindex="-1"></a>    <span class="fu">step_poly</span>(DriverAge, <span class="at">degree=</span><span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb181-19"><a href="#cb181-19" tabindex="-1"></a>    <span class="fu">step_poly</span>(CarAge, <span class="at">degree=</span><span class="dv">2</span>)</span>
<span id="cb181-20"><a href="#cb181-20" tabindex="-1"></a></span>
<span id="cb181-21"><a href="#cb181-21" tabindex="-1"></a>m_mod <span class="ot">=</span> <span class="fu">poisson_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb181-22"><a href="#cb181-22" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;glm&quot;</span>) </span>
<span id="cb181-23"><a href="#cb181-23" tabindex="-1"></a></span>
<span id="cb181-24"><a href="#cb181-24" tabindex="-1"></a>m11_wflow <span class="ot">&lt;-</span> </span>
<span id="cb181-25"><a href="#cb181-25" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb181-26"><a href="#cb181-26" tabindex="-1"></a>  <span class="fu">add_model</span>(m_mod, <span class="at">formula =</span> ClaimNb <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure)) <span class="sc">+</span> . <span class="sc">-</span> Exposure) <span class="sc">%&gt;%</span> <span class="co"># Formula of the model</span></span>
<span id="cb181-27"><a href="#cb181-27" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb181-28"><a href="#cb181-28" tabindex="-1"></a></span>
<span id="cb181-29"><a href="#cb181-29" tabindex="-1"></a>m11_fit <span class="ot">=</span> m11_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb181-30"><a href="#cb181-30" tabindex="-1"></a>    <span class="fu">fit</span>(training_set)</span>
<span id="cb181-31"><a href="#cb181-31" tabindex="-1"></a></span>
<span id="cb181-32"><a href="#cb181-32" tabindex="-1"></a>predt <span class="ot">=</span> <span class="fu">predict</span>(m11_fit, testing_set)</span></code></pre></div>
<p>Residual deviance:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" tabindex="-1"></a><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="at">x =</span> testing_set<span class="sc">$</span>ClaimNb, <span class="at">lambda =</span> testing_set<span class="sc">$</span>ClaimNb,</span>
<span id="cb182-2"><a href="#cb182-2" tabindex="-1"></a>    <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="at">x =</span> testing_set<span class="sc">$</span>ClaimNb, <span class="at">lambda =</span> <span class="fu">pull</span>(predt, <span class="st">&quot;.pred&quot;</span>), <span class="at">log =</span> <span class="cn">TRUE</span>)))</span></code></pre></div>
<pre><code>## [1] 20529.66</code></pre>
</div>
<div id="partial-dependencies" class="section level2">
<h2>Partial dependencies</h2>
<p>We can visualize our model, with partial dependencies (more on how it
is constructed later).</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb184-2"><a href="#cb184-2" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb184-3"><a href="#cb184-3" tabindex="-1"></a></span>
<span id="cb184-4"><a href="#cb184-4" tabindex="-1"></a>partial_dep <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">DriverAge =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(training_set<span class="sc">$</span>DriverAge)), <span class="at">pred=</span><span class="dv">0</span>)</span>
<span id="cb184-5"><a href="#cb184-5" tabindex="-1"></a></span>
<span id="cb184-6"><a href="#cb184-6" tabindex="-1"></a><span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partial_dep)){</span>
<span id="cb184-7"><a href="#cb184-7" tabindex="-1"></a>    driver_age <span class="ot">=</span> <span class="fu">as.numeric</span>(partial_dep[row, <span class="st">&quot;DriverAge&quot;</span>])</span>
<span id="cb184-8"><a href="#cb184-8" tabindex="-1"></a>    </span>
<span id="cb184-9"><a href="#cb184-9" tabindex="-1"></a>    partial_dep[row, <span class="st">&quot;pred&quot;</span>] <span class="ot">=</span> <span class="fu">mean</span>((<span class="fu">predict</span>(m11_fit, </span>
<span id="cb184-10"><a href="#cb184-10" tabindex="-1"></a>                                             <span class="at">new_data =</span> training_set </span>
<span id="cb184-11"><a href="#cb184-11" tabindex="-1"></a>                                             <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DriverAge =</span> driver_age))<span class="sc">/</span>training_set<span class="sc">$</span>Exposure)<span class="sc">$</span>.pred)</span>
<span id="cb184-12"><a href="#cb184-12" tabindex="-1"></a>}</span>
<span id="cb184-13"><a href="#cb184-13" tabindex="-1"></a></span>
<span id="cb184-14"><a href="#cb184-14" tabindex="-1"></a><span class="fu">ggplot</span>(partial_dep, <span class="fu">aes</span>(<span class="at">x=</span>DriverAge, <span class="at">y=</span>pred)) <span class="sc">+</span> </span>
<span id="cb184-15"><a href="#cb184-15" tabindex="-1"></a><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb184-16"><a href="#cb184-16" tabindex="-1"></a><span class="fu">geom_line</span>()<span class="sc">+</span> </span>
<span id="cb184-17"><a href="#cb184-17" tabindex="-1"></a><span class="fu">scale_x_continuous</span>(<span class="at">name=</span><span class="st">&quot;Driver Age&quot;</span>)<span class="sc">+</span></span>
<span id="cb184-18"><a href="#cb184-18" tabindex="-1"></a><span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Predicted Claim Frequency&quot;</span>, <span class="at">labels=</span><span class="fu">label_percent</span>(<span class="at">accuracy=</span><span class="fl">0.01</span>))</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" tabindex="-1"></a>partial_dep <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">CarAge =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(training_set<span class="sc">$</span>CarAge)), <span class="at">pred=</span><span class="dv">0</span>)</span>
<span id="cb185-2"><a href="#cb185-2" tabindex="-1"></a></span>
<span id="cb185-3"><a href="#cb185-3" tabindex="-1"></a><span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partial_dep)){</span>
<span id="cb185-4"><a href="#cb185-4" tabindex="-1"></a>    car_age <span class="ot">=</span> <span class="fu">as.numeric</span>(partial_dep[row, <span class="st">&quot;CarAge&quot;</span>])</span>
<span id="cb185-5"><a href="#cb185-5" tabindex="-1"></a>    </span>
<span id="cb185-6"><a href="#cb185-6" tabindex="-1"></a>    partial_dep[row, <span class="st">&quot;pred&quot;</span>] <span class="ot">=</span> <span class="fu">mean</span>((<span class="fu">predict</span>(m11_fit, </span>
<span id="cb185-7"><a href="#cb185-7" tabindex="-1"></a>                                             <span class="at">new_data =</span> training_set</span>
<span id="cb185-8"><a href="#cb185-8" tabindex="-1"></a>                                             <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">CarAge =</span> car_age))<span class="sc">/</span>training_set<span class="sc">$</span>Exposure)<span class="sc">$</span>.pred)</span>
<span id="cb185-9"><a href="#cb185-9" tabindex="-1"></a>}</span>
<span id="cb185-10"><a href="#cb185-10" tabindex="-1"></a></span>
<span id="cb185-11"><a href="#cb185-11" tabindex="-1"></a><span class="fu">ggplot</span>(partial_dep, <span class="fu">aes</span>(<span class="at">x=</span>CarAge, <span class="at">y=</span>pred)) <span class="sc">+</span> </span>
<span id="cb185-12"><a href="#cb185-12" tabindex="-1"></a><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb185-13"><a href="#cb185-13" tabindex="-1"></a><span class="fu">geom_line</span>()<span class="sc">+</span> </span>
<span id="cb185-14"><a href="#cb185-14" tabindex="-1"></a><span class="fu">scale_x_continuous</span>(<span class="at">name=</span><span class="st">&quot;Car Age&quot;</span>)<span class="sc">+</span></span>
<span id="cb185-15"><a href="#cb185-15" tabindex="-1"></a><span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">&quot;Predicted Claim Frequency&quot;</span>, <span class="at">labels=</span><span class="fu">label_percent</span>(<span class="at">accuracy=</span><span class="fl">0.01</span>))</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="useful-links" class="section level1">
<h1>Useful links</h1>
<ul>
<li><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/main/factors.pdf" class="uri">https://raw.githubusercontent.com/rstudio/cheatsheets/main/factors.pdf</a></li>
<li><a href="https://www.tidymodels.org/index.html" class="uri">https://www.tidymodels.org/index.html</a></li>
<li><a href="https://parsnip.tidymodels.org/" class="uri">https://parsnip.tidymodels.org/</a></li>
<li><a href="https://recipes.tidymodels.org/index.html" class="uri">https://recipes.tidymodels.org/index.html</a></li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
